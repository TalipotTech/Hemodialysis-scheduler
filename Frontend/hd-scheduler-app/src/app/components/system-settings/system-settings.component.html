<div class="container">
  <mat-card class="settings-card">
    <mat-card-header>
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-card-title>System Settings</mat-card-title>
      </div>
    </mat-card-header>
    
    <mat-card-content>
      <mat-tab-group animationDuration="300ms">
        <!-- Bed Capacity Tab -->
        <mat-tab label="Bed Capacity">
          <div class="tab-content">
            <h3>Bed Capacity Management</h3>
            <p class="description">Configure maximum bed capacity per slot</p>
            
            <div *ngIf="loading" class="loading-container">
              <mat-spinner></mat-spinner>
            </div>

            <div *ngIf="!loading && bedCapacities.length > 0" class="capacity-list">
              <div *ngFor="let slot of bedCapacities" class="capacity-card">
                <div class="slot-header">
                  <div class="slot-info">
                    <h4>{{ slot.slotName }}</h4>
                    <span class="slot-id">Slot ID: {{ slot.slotID }}</span>
                  </div>
                  <div class="occupancy-badge" [class.high]="slot.occupancyRate > 80" [class.medium]="slot.occupancyRate > 50 && slot.occupancyRate <= 80">
                    {{ slot.occupancyRate }}% Occupied
                  </div>
                </div>

                <div class="capacity-stats">
                  <div class="stat-item">
                    <mat-icon>hotel</mat-icon>
                    <div class="stat-content">
                      <span class="stat-label">Max Beds</span>
                      <span class="stat-value">{{ slot.maxBeds }}</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <mat-icon class="used-icon">person</mat-icon>
                    <div class="stat-content">
                      <span class="stat-label">Used Beds</span>
                      <span class="stat-value used">{{ slot.usedBeds }}</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <mat-icon class="reserved-icon">event_busy</mat-icon>
                    <div class="stat-content">
                      <span class="stat-label">Reserved</span>
                      <span class="stat-value reserved">{{ slot.reservedBeds }}</span>
                    </div>
                  </div>
                  <div class="stat-item">
                    <mat-icon class="available-icon">check_circle</mat-icon>
                    <div class="stat-content">
                      <span class="stat-label">Available</span>
                      <span class="stat-value available">{{ slot.availableBeds }}</span>
                    </div>
                  </div>
                </div>

                <div class="capacity-edit" *ngIf="editingSlotId !== slot.slotID">
                  <button mat-raised-button color="primary" (click)="startEdit(slot.slotID)">
                    <mat-icon>edit</mat-icon>
                    Edit Capacity
                  </button>
                </div>

                <div class="capacity-edit-form" *ngIf="editingSlotId === slot.slotID">
                  <div class="capacity-control">
                    <button mat-mini-fab color="accent" (click)="decrementBeds(slot.slotID)" 
                            [disabled]="tempMaxBeds[slot.slotID] <= slot.usedBeds || loading">
                      <mat-icon>remove</mat-icon>
                    </button>
                    
                    <mat-form-field appearance="outline" class="capacity-input">
                      <mat-label>Maximum Beds</mat-label>
                      <input matInput type="number" [(ngModel)]="tempMaxBeds[slot.slotID]" 
                             min="{{ slot.usedBeds }}" max="100" placeholder="Bed capacity">
                      <mat-icon matPrefix>hotel</mat-icon>
                    </mat-form-field>
                    
                    <button mat-mini-fab color="accent" (click)="incrementBeds(slot.slotID)" 
                            [disabled]="tempMaxBeds[slot.slotID] >= 100 || loading">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                  <div class="capacity-hint">
                    <mat-icon class="info-icon">info</mat-icon>
                    <span>Current usage: {{ slot.usedBeds }} beds | Min: {{ slot.usedBeds }}, Max: 100</span>
                  </div>
                  <div class="edit-actions">
                    <button mat-raised-button color="primary" (click)="saveBedCapacity(slot.slotID)" [disabled]="loading">
                      <mat-icon>save</mat-icon>
                      Save Changes
                    </button>
                    <button mat-button (click)="cancelEdit(slot.slotID)" [disabled]="loading">
                      <mat-icon>close</mat-icon>
                      Cancel
                    </button>
                  </div>
                </div>

                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="slot.occupancyRate"></div>
                </div>
              </div>
            </div>

            <div *ngIf="!loading && bedCapacities.length === 0" class="empty-state">
              <mat-icon>info</mat-icon>
              <p>No slot configurations found</p>
            </div>
          </div>
        </mat-tab>

        <!-- Bed Naming Configuration Tab -->
        <mat-tab label="Bed Naming">
          <div class="tab-content">
            <h3>üõèÔ∏è Bed Naming Configuration</h3>
            <p class="description">Choose how beds are named and displayed throughout the system</p>
            
            <div *ngIf="bedNamingLoading" class="loading-container">
              <mat-spinner></mat-spinner>
            </div>

            <div *ngIf="!bedNamingLoading" class="bed-naming-config">
              <!-- Pattern Selection -->
              <div class="config-section">
                <h4><mat-icon>label</mat-icon> Naming Pattern</h4>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Select Bed Naming Pattern</mat-label>
                  <mat-select [(ngModel)]="selectedPattern" (selectionChange)="onPatternChange()">
                    <mat-option *ngFor="let pattern of availablePatterns" [value]="pattern.value">
                      <div class="pattern-option">
                        <strong>{{ pattern.label }}</strong>
                        <small>{{ pattern.description }}</small>
                      </div>
                    </mat-option>
                  </mat-select>
                  <mat-icon matPrefix>format_list_numbered</mat-icon>
                  <mat-hint>Choose how bed numbers are displayed</mat-hint>
                </mat-form-field>

                <!-- Pattern Description -->
                <div class="pattern-info" *ngIf="selectedPattern">
                  <mat-icon class="info-icon">info</mat-icon>
                  <span>{{ getPatternDescription(selectedPattern) }}</span>
                </div>
              </div>

              <!-- Prefix Configuration (for PREFIXED_NUMERIC) -->
              <div class="config-section" *ngIf="selectedPattern === 'PREFIXED_NUMERIC'">
                <h4><mat-icon>text_fields</mat-icon> Prefix</h4>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Bed Prefix</mat-label>
                  <input matInput [(ngModel)]="bedPrefix" (ngModelChange)="onConfigChange()" placeholder="e.g., Bed, Room, Ward">
                  <mat-icon matPrefix>label</mat-icon>
                  <mat-hint>Text to appear before the number</mat-hint>
                </mat-form-field>
              </div>

              <!-- Beds Per Group (for ALPHA_NUMERIC) -->
              <div class="config-section" *ngIf="selectedPattern === 'ALPHA_NUMERIC'">
                <h4><mat-icon>grid_view</mat-icon> Beds Per Group</h4>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Beds Per Letter Group</mat-label>
                  <input matInput type="number" [(ngModel)]="bedsPerGroup" (ngModelChange)="onConfigChange()" 
                         min="1" max="10" placeholder="e.g., 5">
                  <mat-icon matPrefix>grid_on</mat-icon>
                  <mat-hint>How many beds per letter (e.g., 5 = A1-A5, B1-B5)</mat-hint>
                </mat-form-field>
              </div>

              <!-- Custom Format (for CUSTOM) -->
              <div class="config-section" *ngIf="selectedPattern === 'CUSTOM'">
                <h4><mat-icon>code</mat-icon> Custom Format</h4>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Format String</mat-label>
                  <input matInput [(ngModel)]="customFormat" (ngModelChange)="onConfigChange()" 
                         placeholder="e.g., D, Ward-A, ICU-B, or use {{'{n}'}}, {{'{a}'}}">
                  <mat-icon matPrefix>edit</mat-icon>
                  <mat-hint>Type a letter (D, W, R, etc.) and bed numbers will auto-append. Or use placeholders.</mat-hint>
                </mat-form-field>
                <div class="format-help">
                  <strong>Easy Mode:</strong>
                  <ul>
                    <li>Type <code>D</code> ‚Üí D1, D2, D3, D4...</li>
                    <li>Type <code>Ward-A</code> ‚Üí Ward-A1, Ward-A2, Ward-A3...</li>
                    <li>Type <code>ICU-B</code> ‚Üí ICU-B1, ICU-B2, ICU-B3...</li>
                  </ul>
                  <strong>Advanced Placeholders:</strong>
                  <ul>
                    <li><code>{{ '{n}' }}</code> - Bed number (1, 2, 3...)</li>
                    <li><code>{{ '{N}' }}</code> - Zero-padded number (01, 02, 03...)</li>
                    <li><code>{{ '{a}' }}</code> - Letter group (A, B, C...)</li>
                    <li><code>{{ '{g}' }}</code> - Number within group (1-5)</li>
                  </ul>
                </div>
              </div>

              <!-- Live Preview -->
              <div class="preview-section">
                <h4><mat-icon>visibility</mat-icon> Preview (First 10 Beds)</h4>
                <div class="preview-container">
                  <mat-chip-listbox>
                    <mat-chip *ngFor="let bed of previewBeds" class="preview-chip">
                      <mat-icon>hotel</mat-icon>
                      {{ bed }}
                    </mat-chip>
                  </mat-chip-listbox>
                </div>
                <p class="preview-note">
                  <mat-icon class="note-icon">info</mat-icon>
                  This shows how the first 10 beds will be displayed throughout the system
                </p>
              </div>

              <!-- Action Buttons -->
              <div class="action-buttons">
                <button mat-raised-button color="primary" (click)="saveBedNamingConfiguration()" 
                        [disabled]="bedNamingLoading">
                  <mat-icon>save</mat-icon>
                  Save Configuration
                </button>
                <button mat-button (click)="resetToDefault()" [disabled]="bedNamingLoading">
                  <mat-icon>refresh</mat-icon>
                  Reset to Default
                </button>
              </div>

              <!-- Warning Message -->
              <div class="warning-message">
                <mat-icon class="warning-icon">warning</mat-icon>
                <div class="warning-content">
                  <strong>Important:</strong> Changing the bed naming pattern will affect how beds are displayed 
                  throughout the system. Existing bed assignments will remain intact, only the display format will change.
                </div>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- System Parameters Tab -->
        <mat-tab label="System Parameters">
          <div class="tab-content">
            <h3>System Overview</h3>
            <p class="description">View key system statistics</p>

            <div *ngIf="systemParameters" class="parameters-grid simplified">
              <div class="parameter-card featured">
                <mat-icon class="param-icon beds">hotel</mat-icon>
                <div class="param-content">
                  <span class="param-label">Total Bed Capacity</span>
                  <span class="param-value">{{ systemParameters.totalBedCapacity }}</span>
                  <span class="param-subtitle">beds across all slots</span>
                </div>
              </div>

              <div class="parameter-card featured">
                <mat-icon class="param-icon patients">people</mat-icon>
                <div class="param-content">
                  <span class="param-label">Active Patients</span>
                  <span class="param-value">{{ systemParameters.totalActivePatients }}</span>
                  <span class="param-subtitle">currently in system</span>
                </div>
              </div>
            </div>

            <div *ngIf="!systemParameters" class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
