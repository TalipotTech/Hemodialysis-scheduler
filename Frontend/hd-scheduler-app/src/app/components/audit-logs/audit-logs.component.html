<div class="container">
  <mat-card>
    <mat-card-header>
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" matTooltip="Go Back">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-title">
          <mat-card-title>Audit Logs</mat-card-title>
          <mat-card-subtitle>Complete system audit trail and activity monitoring</mat-card-subtitle>
        </div>
      </div>
    </mat-card-header>

    <mat-card-content>
      <mat-tab-group animationDuration="300ms">
        <!-- All Logs Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">list_alt</mat-icon>
            All Logs
          </ng-template>
          <div class="tab-content">
            <!-- Filters -->
            <div class="filters-container">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Action Type</mat-label>
                <mat-select [(ngModel)]="selectedAction" (selectionChange)="filterByAction()">
                  <mat-option value="">All Actions</mat-option>
                  <mat-option *ngFor="let action of actions" [value]="action">
                    {{ action }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Start Date</mat-label>
                <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate">
                <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>End Date</mat-label>
                <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate">
                <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>

              <button mat-raised-button color="primary" (click)="filterByDateRange()" 
                      [disabled]="!startDate || !endDate">
                <mat-icon>filter_alt</mat-icon>
                Apply Date Filter
              </button>

              <button mat-raised-button (click)="clearFilters()">
                <mat-icon>clear</mat-icon>
                Clear Filters
              </button>
            </div>

            <!-- Loading Spinner -->
            <div *ngIf="allLogsLoading" class="loading-container">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Loading audit logs...</p>
            </div>

            <!-- Syncfusion Grid -->
            <div *ngIf="!allLogsLoading" class="table-container">
              <ejs-grid [dataSource]="allLogsData" 
                        [allowPaging]="true" 
                        [allowSorting]="true"
                        [allowFiltering]="true"
                        [pageSettings]="pageSettings"
                        [filterSettings]="filterSettings"
                        [toolbar]="toolbar"
                        height="500">
                <e-columns>
                  <e-column field="logID" headerText="ID" width="80" textAlign="Center"></e-column>
                  <e-column field="createdAt" headerText="Timestamp" width="180" format="yMd"></e-column>
                  <e-column field="username" headerText="User" width="150"></e-column>
                  <e-column field="action" headerText="Action" width="120"></e-column>
                  <e-column field="entityType" headerText="Entity Type" width="150"></e-column>
                  <e-column field="entityID" headerText="Entity ID" width="120"></e-column>
                  <e-column field="ipAddress" headerText="IP Address" width="150"></e-column>
                </e-columns>
              </ejs-grid>
            </div>
          </div>
        </mat-tab>

        <!-- Login History Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">login</mat-icon>
            Login History
          </ng-template>
          <div class="tab-content">
            <div class="section-header">
              <h3>User Login/Logout History</h3>
              <div class="controls">
                <mat-form-field appearance="outline" class="days-selector">
                  <mat-label>Last N Days</mat-label>
                  <mat-select [(ngModel)]="loginDays" (selectionChange)="updateLoginHistory()">
                    <mat-option [value]="7">7 Days</mat-option>
                    <mat-option [value]="30">30 Days</mat-option>
                    <mat-option [value]="60">60 Days</mat-option>
                    <mat-option [value]="90">90 Days</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Loading Spinner -->
            <div *ngIf="loginHistoryLoading" class="loading-container">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Loading login history...</p>
            </div>

            <!-- Syncfusion Grid for Login History -->
            <div *ngIf="!loginHistoryLoading" class="table-container">
              <ejs-grid [dataSource]="loginHistoryData"
                        [allowPaging]="true"
                        [allowSorting]="true"
                        [allowFiltering]="true"
                        [pageSettings]="pageSettings"
                        [filterSettings]="filterSettings"
                        [toolbar]="toolbar"
                        height="500">
                <e-columns>
                  <e-column field="createdAt" headerText="Timestamp" width="180" format="yMd"></e-column>
                  <e-column field="username" headerText="User" width="150"></e-column>
                  <e-column field="action" headerText="Action" width="120"></e-column>
                  <e-column field="ipAddress" headerText="IP Address" width="150"></e-column>
                </e-columns>
              </ejs-grid>
            </div>
          </div>
        </mat-tab>

        <!-- Statistics Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">analytics</mat-icon>
            Statistics
          </ng-template>
          <div class="tab-content">
            <div class="section-header">
              <h3>Audit Statistics & Analytics</h3>
              <mat-form-field appearance="outline" class="days-selector">
                <mat-label>Time Period</mat-label>
                <mat-select [(ngModel)]="statisticsDays" (selectionChange)="updateStatistics()">
                  <mat-option [value]="7">Last 7 Days</mat-option>
                  <mat-option [value]="30">Last 30 Days</mat-option>
                  <mat-option [value]="60">Last 60 Days</mat-option>
                  <mat-option [value]="90">Last 90 Days</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <!-- Loading Spinner -->
            <div *ngIf="statisticsLoading" class="loading-container">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Loading statistics...</p>
            </div>

            <!-- Statistics Cards -->
            <div *ngIf="!statisticsLoading && statistics" class="statistics-grid">
              <mat-card class="stat-card">
                <mat-icon class="stat-icon total">assessment</mat-icon>
                <div class="stat-content">
                  <h4>Total Actions</h4>
                  <p class="stat-value">{{ statistics.totalActions }}</p>
                </div>
              </mat-card>

              <mat-card class="stat-card">
                <mat-icon class="stat-icon users">people</mat-icon>
                <div class="stat-content">
                  <h4>Unique Users</h4>
                  <p class="stat-value">{{ statistics.uniqueUsers }}</p>
                </div>
              </mat-card>

              <mat-card class="stat-card">
                <mat-icon class="stat-icon login">login</mat-icon>
                <div class="stat-content">
                  <h4>Logins</h4>
                  <p class="stat-value">{{ statistics.loginCount }}</p>
                </div>
              </mat-card>

              <mat-card class="stat-card">
                <mat-icon class="stat-icon create">add_circle</mat-icon>
                <div class="stat-content">
                  <h4>Creates</h4>
                  <p class="stat-value">{{ statistics.createCount }}</p>
                </div>
              </mat-card>

              <mat-card class="stat-card">
                <mat-icon class="stat-icon update">edit</mat-icon>
                <div class="stat-content">
                  <h4>Updates</h4>
                  <p class="stat-value">{{ statistics.updateCount }}</p>
                </div>
              </mat-card>

              <mat-card class="stat-card">
                <mat-icon class="stat-icon delete">delete</mat-icon>
                <div class="stat-content">
                  <h4>Deletes</h4>
                  <p class="stat-value">{{ statistics.deleteCount }}</p>
                </div>
              </mat-card>
            </div>

            <!-- Top Insights -->
            <div *ngIf="!statisticsLoading && statistics" class="insights-section">
              <mat-card class="insight-card">
                <h4><mat-icon>star</mat-icon> Most Active User</h4>
                <p class="insight-value">{{ statistics.mostActiveUser }}</p>
              </mat-card>

              <mat-card class="insight-card">
                <h4><mat-icon>trending_up</mat-icon> Most Common Action</h4>
                <p class="insight-value">{{ statistics.mostCommonAction }}</p>
              </mat-card>
            </div>

            <!-- User Activity Table -->
            <div *ngIf="!activityLoading && userActivity.length > 0" class="activity-section">
              <h4>User Activity Summary</h4>
              <div class="activity-grid">
                <mat-card *ngFor="let user of userActivity" class="activity-card">
                  <div class="activity-header">
                    <mat-icon class="user-avatar">account_circle</mat-icon>
                    <div class="user-info">
                      <h5>{{ user.username }}</h5>
                      <span class="role-badge">{{ user.role }}</span>
                    </div>
                  </div>
                  <div class="activity-details">
                    <div class="detail-item">
                      <span class="label">Last Action:</span>
                      <span class="value">{{ user.lastAction }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">Last Active:</span>
                      <span class="value">{{ formatDate(user.lastActivityTime) }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">Total Actions:</span>
                      <span class="value highlight">{{ user.actionCount }}</span>
                    </div>
                  </div>
                </mat-card>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
