<div class="patient-form-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <div class="header-row">
          <div class="header-left">
            <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Go Back">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>{{ isEditMode ? 'Edit Patient' : 'Add New Patient' }}</h2>
          </div>
          <div class="header-right">
            <button mat-icon-button (click)="goToAdminDashboard()" matTooltip="Go to Admin Dashboard">
              <mat-icon>home</mat-icon>
            </button>
            <button mat-icon-button (click)="onCancel()" matTooltip="Close">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <!-- Read-Only Access Warning -->
    @if (isReadOnly) {
      <div class="read-only-banner">
        <mat-icon>lock</mat-icon>
        <span><strong>READ-ONLY MODE:</strong> Technicians cannot create or edit patient records. Only viewing is allowed.</span>
      </div>
    }

    <mat-card-content>
      @if (loading && isEditMode) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      }

      @if (errorMessage) {
        <div class="error-message">
          <mat-icon>error</mat-icon>
          {{ errorMessage }}
        </div>
      }

      <form [formGroup]="patientForm" (ngSubmit)="onSubmit()">
        <!-- Basic Patient Information -->
        <h3>Basic Patient Information</h3>
        
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>MRN (Medical Record Number)</mat-label>
            <input matInput formControlName="mrn" placeholder="Enter MRN">
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Patient Full Name *</mat-label>
            <input matInput formControlName="name" placeholder="Enter patient full name" required>
            <mat-hint>Required</mat-hint>
            @if (patientForm.get('name')?.invalid && (patientForm.get('name')?.touched || patientForm.get('name')?.dirty)) {
              <mat-error>Name is required (min 2 characters)</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Age (years) *</mat-label>
            <input matInput type="number" formControlName="age" placeholder="Enter patient age" required>
            <mat-hint>Required</mat-hint>
            @if (patientForm.get('age')?.invalid && (patientForm.get('age')?.touched || patientForm.get('age')?.dirty)) {
              <mat-error>
                @if (patientForm.get('age')?.hasError('required')) {
                  Age is required
                } @else if (patientForm.get('age')?.hasError('min')) {
                  Age must be at least 1
                } @else if (patientForm.get('age')?.hasError('max')) {
                  Age must be less than 120
                }
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Gender *</mat-label>
            <mat-select formControlName="gender" required>
              <mat-option value="Male">Male</mat-option>
              <mat-option value="Female">Female</mat-option>
              <mat-option value="Other">Other</mat-option>
            </mat-select>
            <mat-hint>Required</mat-hint>
            @if (patientForm.get('gender')?.invalid && (patientForm.get('gender')?.touched || patientForm.get('gender')?.dirty)) {
              <mat-error>Gender is required</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Contact Number *</mat-label>
            <input matInput type="tel" formControlName="contactNumber" placeholder="Enter 10 digit phone number (e.g., 9876543210)" required maxlength="10">
            <mat-hint>Required - 10 digits</mat-hint>
            @if (patientForm.get('contactNumber')?.invalid && (patientForm.get('contactNumber')?.touched || patientForm.get('contactNumber')?.dirty)) {
              @if (patientForm.get('contactNumber')?.hasError('required')) {
                <mat-error>Contact number is required</mat-error>
              } @else if (patientForm.get('contactNumber')?.hasError('pattern')) {
                <mat-error>Please enter exactly 10 digits (numbers only)</mat-error>
              }
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Emergency Contact</mat-label>
            <input matInput type="tel" formControlName="emergencyContact" placeholder="Enter 10 digit phone number (e.g., 9876543210)" maxlength="10">
            @if (patientForm.get('emergencyContact')?.invalid && patientForm.get('emergencyContact')?.touched) {
              <mat-error>Please enter exactly 10 digits (numbers only)</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Address</mat-label>
            <input matInput formControlName="address" placeholder="Enter patient address">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Guardian Name</mat-label>
            <input matInput formControlName="guardianName" placeholder="Enter guardian name">
          </mat-form-field>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          @if (patientForm.invalid && patientForm.touched) {
            <div class="validation-warning">
              <mat-icon>info</mat-icon>
              <span>Please fill in all required fields (marked with *) to save</span>
            </div>
          }
          <div class="action-buttons">
            <button mat-button type="button" (click)="onCancel()">{{ isReadOnly ? 'Back' : 'Cancel' }}</button>
            @if (!isReadOnly) {
              <button mat-raised-button color="primary" type="submit" [disabled]="loading || patientForm.invalid">
                @if (loading) {
                  <mat-spinner diameter="20"></mat-spinner>
                } @else {
                  {{ isEditMode ? 'Save Changes' : 'Save Patient' }}
                }
              </button>
            }
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
