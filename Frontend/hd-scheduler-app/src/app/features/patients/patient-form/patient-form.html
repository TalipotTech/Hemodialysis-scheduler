<div class="patient-form-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <div class="header-row">
          <div class="header-left">
            <button mat-icon-button (click)="goToAdminDashboard()" class="home-button" matTooltip="Home">
              <mat-icon>home</mat-icon>
            </button>
            <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Back">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Patient Form</h2>
          </div>
          <div class="header-right">
            <!-- Auto-save indicator -->
            <div class="auto-save-indicator" [class.saving]="saveStatus === 'saving'" [class.saved]="saveStatus === 'saved'" [class.visible]="saveStatus !== 'idle'">
              @if (saveStatus === 'saving') {
                <mat-spinner diameter="16"></mat-spinner>
                <span>Saving...</span>
              }
              @if (saveStatus === 'saved') {
                <mat-icon>check_circle</mat-icon>
                <span>Saved</span>
              }
            </div>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <!-- Read-Only Access Warning -->
    @if (isReadOnly) {
      <div class="read-only-banner">
        <mat-icon>lock</mat-icon>
        <span><strong>READ-ONLY MODE:</strong> Technicians cannot create or edit patient records. Only viewing is allowed.</span>
      </div>
    }

    <mat-card-content>
      @if (loading && isEditMode) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      }

      @if (errorMessage) {
        <div class="error-message">
          <mat-icon>error</mat-icon>
          {{ errorMessage }}
        </div>
      }

      <form [formGroup]="patientForm" (ngSubmit)="onSubmit()">
        <!-- Basic Patient Information -->
        <h3>Basic Patient Information</h3>
        
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>MRN (Medical Record Number)</mat-label>
            <input matInput formControlName="mrn" placeholder="Enter MRN">
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Patient Full Name *</mat-label>
            <input matInput formControlName="name" placeholder="Enter patient full name" required>
            <mat-hint>Required</mat-hint>
            @if (patientForm.get('name')?.invalid && (patientForm.get('name')?.touched || patientForm.get('name')?.dirty)) {
              <mat-error>Name is required (min 2 characters)</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Age (years) *</mat-label>
            <input matInput type="number" formControlName="age" placeholder="Enter patient age" required>
            <mat-hint>Required</mat-hint>
            @if (patientForm.get('age')?.invalid && (patientForm.get('age')?.touched || patientForm.get('age')?.dirty)) {
              <mat-error>
                @if (patientForm.get('age')?.hasError('required')) {
                  Age is required
                } @else if (patientForm.get('age')?.hasError('min')) {
                  Age must be at least 1
                } @else if (patientForm.get('age')?.hasError('max')) {
                  Age must be less than 120
                }
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Gender *</mat-label>
            <mat-select formControlName="gender" required>
              <mat-option value="Male">Male</mat-option>
              <mat-option value="Female">Female</mat-option>
              <mat-option value="Other">Other</mat-option>
            </mat-select>
            <mat-hint>Required</mat-hint>
            @if (patientForm.get('gender')?.invalid && (patientForm.get('gender')?.touched || patientForm.get('gender')?.dirty)) {
              <mat-error>Gender is required</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Contact Number *</mat-label>
            <input matInput type="tel" formControlName="contactNumber" placeholder="Enter 10 digit phone number (e.g., 9876543210)" required maxlength="10">
            <mat-hint>Required - 10 digits</mat-hint>
            @if (patientForm.get('contactNumber')?.invalid && (patientForm.get('contactNumber')?.touched || patientForm.get('contactNumber')?.dirty)) {
              @if (patientForm.get('contactNumber')?.hasError('required')) {
                <mat-error>Contact number is required</mat-error>
              } @else if (patientForm.get('contactNumber')?.hasError('pattern')) {
                <mat-error>Please enter exactly 10 digits (numbers only)</mat-error>
              }
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Emergency Contact</mat-label>
            <input matInput type="tel" formControlName="emergencyContact" placeholder="Enter 10 digit phone number (e.g., 9876543210)" maxlength="10">
            @if (patientForm.get('emergencyContact')?.invalid && patientForm.get('emergencyContact')?.touched) {
              <mat-error>Please enter exactly 10 digits (numbers only)</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Address</mat-label>
            <input matInput formControlName="address" placeholder="Enter patient address">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Guardian Name</mat-label>
            <input matInput formControlName="guardianName" placeholder="Enter guardian name">
          </mat-form-field>
        </div>

        <!-- Basic HD Information -->
        <h3>Basic HD Information</h3>
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Dry Weight (kg)</mat-label>
            <input matInput type="number" formControlName="dryWeight" placeholder="Enter dry weight" step="0.1">
            <mat-hint>Target weight after dialysis</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>HD Start Date</mat-label>
            <input matInput [matDatepicker]="hdStartPicker" formControlName="hdStartDate" placeholder="Select date">
            <mat-datepicker-toggle matSuffix [for]="hdStartPicker"></mat-datepicker-toggle>
            <mat-datepicker #hdStartPicker></mat-datepicker>
            <mat-hint>When HD treatment began</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>HD Cycle (Days Pattern)</mat-label>
            <mat-select formControlName="hdCycle" (selectionChange)="onHDCycleChange()">
              <mat-option value="">Not Set</mat-option>
              @for (cycle of hdCycles; track cycle.value) {
                <mat-option [value]="cycle.value">{{ cycle.label }}</mat-option>
              }
            </mat-select>
            <mat-hint>Select the weekly dialysis pattern</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Sessions Per Week</mat-label>
            <input matInput formControlName="hdFrequency" type="number" min="1" max="7" placeholder="e.g., 3">
            <mat-hint>Number of dialysis sessions per week</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Preferred Time Slot</mat-label>
            <mat-select formControlName="preferredSlotID">
              <mat-option [value]="1">Morning (06:00 - 10:00)</mat-option>
              <mat-option [value]="2">Afternoon (11:00 - 15:00)</mat-option>
              <mat-option [value]="3">Evening (16:00 - 20:00)</mat-option>
              <mat-option [value]="4">Night (21:00 - 01:00)</mat-option>
            </mat-select>
            <mat-hint>Preferred time slot for recurring sessions</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Prescribed Duration (hours)</mat-label>
            <input matInput type="number" formControlName="prescribedDuration" step="0.5" placeholder="4">
            <mat-hint>Typically 3.5 - 5 hours</mat-hint>
          </mat-form-field>
        </div>

        <!-- Dialyser & Dialysate -->
        <h3>Dialyser & Dialysate</h3>
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Dialyser Type</mat-label>
            <mat-select formControlName="dialyserType">
              @for (type of dialyserTypes; track type) {
                <mat-option [value]="type">{{ type }}</mat-option>
              }
            </mat-select>
            <mat-hint>HI/LO flux</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Dialyser Model</mat-label>
            <input matInput formControlName="dialyserModel" placeholder="Enter model">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Prescribed BFR (mL/min)</mat-label>
            <input matInput type="number" formControlName="prescribedBFR" placeholder="e.g., 400">
            <mat-hint>Blood flow rate</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Dialysate Prescription</mat-label>
            <mat-select formControlName="dialysatePrescription">
              @for (prescription of dialysatePrescriptions; track prescription) {
                <mat-option [value]="prescription">{{ prescription }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Equipment Usage Tracking -->
        <h3>Equipment Usage & Session History</h3>
        
        <!-- Equipment Usage Alert Component -->
        <app-equipment-usage-alert
          [dialyserCount]="patientForm.get('dialyserCount')?.value || 0"
          [bloodTubingCount]="patientForm.get('bloodTubingCount')?.value || 0"
          [showDetails]="true">
        </app-equipment-usage-alert>
        
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Dialyser Use Number</mat-label>
            <input matInput type="number" formControlName="dialyserCount" placeholder="0" min="0" max="7" 
                   (input)="validateDialyserCount($event)">
            <mat-hint>Current dialyser usage count (Max: 7)</mat-hint>
            @if (patientForm.get('dialyserCount')?.hasError('max')) {
              <mat-error>⚠️ Maximum is 7. Patient must bring new dialyser!</mat-error>
            }
            @if (patientForm.get('dialyserCount')?.hasError('min')) {
              <mat-error>⚠️ Minimum is 0</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Blood Tubing Number</mat-label>
            <input matInput type="number" formControlName="bloodTubingCount" placeholder="0" min="0" max="12"
                   (input)="validateBloodTubingCount($event)">
            <mat-hint>Current blood tubing usage count (Max: 12)</mat-hint>
            @if (patientForm.get('bloodTubingCount')?.hasError('max')) {
              <mat-error>⚠️ Maximum is 12. Patient must bring new tubing!</mat-error>
            }
            @if (patientForm.get('bloodTubingCount')?.hasError('min')) {
              <mat-error>⚠️ Minimum is 0</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Total No. of Dialysis</mat-label>
            <input matInput type="number" formControlName="totalDialysisCompleted" placeholder="0" readonly>
            <mat-hint>Auto-updated after each dialysis session</mat-hint>
            <mat-icon matSuffix matTooltip="This field updates automatically when HD sessions are completed">info</mat-icon>
          </mat-form-field>
        </div>

        @if (isEditMode) {
          <div class="form-row">
            <button mat-raised-button 
                    type="button"
                    color="accent"
                    (click)="reloadEquipmentCounts()"
                    [disabled]="loading"
                    style="margin-bottom: 16px;">
              <mat-icon>refresh</mat-icon>
              Reload Counts from Latest Session
            </button>
          </div>
        }

        <!-- Form Actions -->
        <div class="form-actions">
          @if (patientForm.invalid && patientForm.touched) {
            <div class="validation-warning">
              <mat-icon>info</mat-icon>
              <span>Please fill in all required fields (marked with **) to save</span>
            </div>
          }
          <div class="action-buttons">
            <button mat-button type="button" (click)="onCancel()">{{ isReadOnly ? 'Back' : 'Cancel' }}</button>
            @if (!isReadOnly) {
              <button mat-raised-button color="primary" type="submit" [disabled]="loading || patientForm.invalid">
                @if (loading) {
                  <mat-spinner diameter="20"></mat-spinner>
                } @else {
                  {{ isEditMode ? 'Save Changes' : 'Save Patient' }}
                }
              </button>
            }
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
