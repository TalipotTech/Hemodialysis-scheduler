<div class="patient-list-container">
  <div class="e-card">
    <div class="e-card-header">
      <div class="e-card-header-title">
        <div class="header-row">
          <div class="header-left">
            <button class="e-btn e-icon-btn" (click)="goHome()" title="Home">
              <mat-icon>home</mat-icon>
            </button>
            <button class="e-btn e-icon-btn" (click)="goBack()" title="Back">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Patient Management</h2>
          </div>
          <div class="header-actions">
            @if (isReadOnly) {
              <span class="warning-chip">
                <mat-icon>lock</mat-icon>
                READ-ONLY ACCESS
              </span>
            }
            <button class="e-btn e-icon-btn refresh-button" (click)="onRefresh()" title="Refresh">
              <mat-icon>refresh</mat-icon>
            </button>
            @if (!isReadOnly) {
              <button class="e-btn e-primary" (click)="onAddPatient()">
                <mat-icon>add</mat-icon>
                Add New Patient
              </button>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="e-card-content">
      <!-- Tabs for Active Patients and Discharged History -->
      <ejs-tab [selectedItem]="selectedTabIndex" (selected)="onTabChange($event.selectedIndex)">
        <e-tabitems>
          
          <!-- Active Patients Tab -->
          <e-tabitem [header]="{'text': 'Active Patients'}">
            <ng-template #content>
              <div class="tab-content">
                <!-- Search Bar -->
                <div class="search-container">
                  <input type="text" 
                         [(ngModel)]="searchTerm" 
                         (input)="onSearch()" 
                         placeholder="Search by name, MRN, or phone"
                         class="search-field">
                </div>

                <!-- Loading Spinner -->
                @if (loading) {
                  <div class="loading-container">
                    <div class="e-spinner-pane">
                      <div class="e-spinner-inner">
                        <div class="e-spin-material"></div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Error Message -->
                @if (errorMessage && !loading) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    {{ errorMessage }}
                  </div>
                }

                <!-- Patient Grid -->
                @if (!loading && !errorMessage && filteredPatients.length > 0) {
                  <ejs-grid
                    [dataSource]="filteredPatients"
                    [allowPaging]="true"
                    [allowSorting]="true"
                    [allowFiltering]="true"
                    [pageSettings]="{ pageSize: 20, pageSizes: [10, 20, 50, 100] }"
                    [filterSettings]="{ type: 'Excel' }">
                    
                    <e-columns>
                      <e-column field="patientID" headerText="ID" width="70"></e-column>
                      <e-column 
                        field="name" 
                        headerText="Patient Name" 
                        width="150"
                        [template]="nameTemplate">
                      </e-column>
                      <e-column field="mrn" headerText="MRN" width="100"></e-column>
                      <e-column field="age" headerText="Age" width="60"></e-column>
                      <e-column field="gender" headerText="Gender" width="80"></e-column>
                      <e-column field="contactNumber" headerText="Contact" width="120"></e-column>
                      <e-column 
                        headerText="Actions" 
                        width="400" 
                        [template]="actionsTemplate">
                      </e-column>
                    </e-columns>
                  </ejs-grid>

                  <!-- Patient Name Template with Hover Info -->
                  <ng-template #nameTemplate let-data>
                    <div class="patient-name-cell" 
                         [matTooltip]="getPatientTooltip(data)" 
                         matTooltipClass="patient-info-tooltip"
                         matTooltipPosition="right">
                      {{ data.name }}
                    </div>
                  </ng-template>

                  <!-- Actions Template -->
                  <ng-template #actionsTemplate let-data>
                    <div class="action-buttons">
                      <button class="e-btn e-small e-info" (click)="onScheduleHD(data)" [disabled]="data.isDischarged" title="Schedule HD">
                        <mat-icon>event_available</mat-icon>
                      </button>
                      <button class="e-btn e-small e-success" (click)="onQuickSchedule(data)" [disabled]="data.isDischarged" title="AI Quick">
                        <mat-icon>psychology</mat-icon>
                      </button>
                      <button class="e-btn e-small e-warning" (click)="onPostSchedule(data)" [disabled]="!data.scheduleID" title="Post">
                        <mat-icon>assignment_turned_in</mat-icon>
                      </button>
                      <button class="e-btn e-small" (click)="onRecordVitals(data)" [disabled]="!data.scheduleID" title="Vitals">
                        <mat-icon>monitor_heart</mat-icon>
                      </button>
                      <button class="e-btn e-small e-info" (click)="onViewHistory(data)" title="History">
                        <mat-icon>history</mat-icon>
                      </button>
                      @if (!isReadOnly) {
                        <button class="e-btn e-small e-primary" (click)="onEditPatient(data)" title="Edit">
                          <mat-icon>edit</mat-icon>
                        </button>
                        @if (!data.isDischarged) {
                          <button class="e-btn e-small e-danger" (click)="onDischargePatient(data)" title="Discharge">
                            <mat-icon>logout</mat-icon>
                          </button>
                        }
                      }
                    </div>
                  </ng-template>
                }

                <!-- Empty State -->
                @if (!loading && !errorMessage && filteredPatients.length === 0) {
                  <div class="empty-state">
                    <mat-icon>people_outline</mat-icon>
                    <h3>No Patients Found</h3>
                    <p>{{ searchTerm ? 'Try a different search term' : 'Start by adding a new patient' }}</p>
                  </div>
                }
              </div>
            </ng-template>
          </e-tabitem>

          <!-- Pre Schedule Tab -->
          <e-tabitem [header]="{'text': 'Pre Schedule'}">
            <ng-template #content>
              <div class="tab-content">
                <div class="section-header">
                  <h3><mat-icon>event</mat-icon> Pre Schedule (Pre-Scheduled & Future Sessions)</h3>
                  <p class="tab-description">Patients with upcoming dialysis sessions but no active treatment today. Includes both pre-scheduled (auto-generated) and manually scheduled sessions.</p>
                </div>

                <!-- Search -->
                <div class="search-container">
                  <input type="text" 
                         [(ngModel)]="reservedSearchTerm" 
                         (input)="onReservedSearch()" 
                         placeholder="Search pre-scheduled patients"
                         class="search-field">
                </div>

                <!-- Loading -->
                @if (loadingReserved) {
                  <div class="loading-container">
                    <div class="e-spinner-pane">
                      <div class="e-spinner-inner">
                        <div class="e-spin-material"></div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Reserved Grid -->
                @if (!loadingReserved && filteredReservedPatients.length > 0) {
                  <ejs-grid
                    [dataSource]="filteredReservedPatients"
                    [allowPaging]="true"
                    [allowSorting]="true"
                    [allowFiltering]="true"
                    [pageSettings]="{ pageSize: 20, pageSizes: [10, 20, 50] }">
                    
                    <e-columns>
                      <e-column field="patientId" headerText="ID" width="70"></e-column>
                      <e-column field="name" headerText="Patient Name" width="150"></e-column>
                      <e-column field="mrn" headerText="MRN" width="100"></e-column>
                      <e-column field="age" headerText="Age" width="60"></e-column>
                      <e-column field="gender" headerText="Gender" width="80"></e-column>
                      <e-column field="hdCycle" headerText="HD Cycle" width="150"></e-column>
                      <e-column field="futureSessionsCount" headerText="Future Sessions" width="120"></e-column>
                      <e-column field="nextScheduledDay" headerText="Next Session" width="150"></e-column>
                      <e-column 
                        headerText="Actions" 
                        width="250" 
                        [template]="reservedActionsTemplate">
                      </e-column>
                    </e-columns>
                  </ejs-grid>

                  <ng-template #reservedActionsTemplate let-data>
                    <div class="action-buttons">
                      <button class="e-btn e-small e-success" 
                              (click)="onActivateReservedPatient(data)" 
                              title="Activate Patient - Schedule Today's Session">
                        <mat-icon>play_arrow</mat-icon>
                        Active
                      </button>
                      <button class="e-btn e-small e-info" 
                              (click)="onViewReservedPatientHistory(data)" 
                              title="View Patient History">
                        <mat-icon>history</mat-icon>
                        History
                      </button>
                      <button class="e-btn e-small e-primary" 
                              (click)="onEditPatient(data)" 
                              title="View Patient Details">
                        <mat-icon>visibility</mat-icon>
                      </button>
                    </div>
                  </ng-template>
                }

                <!-- Empty State -->
                @if (!loadingReserved && filteredReservedPatients.length === 0) {
                  <div class="empty-state">
                    <mat-icon>event_busy</mat-icon>
                    <h3>No Pre-Scheduled Patients Found</h3>
                    <p>Pre-scheduled patients have future scheduled sessions but no active treatment today</p>
                  </div>
                }
              </div>
            </ng-template>
          </e-tabitem>

          <!-- Discharged Patients History Tab -->
          <e-tabitem [header]="{'text': 'Discharged History'}">
            <ng-template #content>
              <div class="tab-content">
                <div class="tab-header">
                  <h3><mat-icon>history</mat-icon> Discharged Patients Treatment History</h3>
                </div>

                <!-- Search -->
                <div class="search-container">
                  <input type="text" 
                         [(ngModel)]="dischargedSearchTerm" 
                         (input)="onDischargedSearch()" 
                         placeholder="Search discharged patients"
                         class="search-field">
                </div>

                <!-- Loading -->
                @if (loadingDischarged) {
                  <div class="loading-container">
                    <div class="e-spinner-pane">
                      <div class="e-spinner-inner">
                        <div class="e-spin-material"></div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Discharged Grid -->
                @if (!loadingDischarged && filteredDischargedPatients.length > 0) {
                  <ejs-grid
                    [dataSource]="filteredDischargedPatients"
                    [allowPaging]="true"
                    [allowSorting]="true"
                    [allowFiltering]="true"
                    [pageSettings]="{ pageSize: 10 }">
                    
                    <e-columns>
                      <e-column field="patientID" headerText="ID" width="70"></e-column>
                      <e-column field="name" headerText="Name" width="150"></e-column>
                      <e-column field="mrn" headerText="MRN" width="100"></e-column>
                      <e-column field="age" headerText="Age" width="60"></e-column>
                      <e-column field="totalDialysisCompleted" headerText="Sessions" width="100"></e-column>
                      <e-column 
                        headerText="Actions" 
                        width="150" 
                        [template]="dischargedActionsTemplate">
                      </e-column>
                    </e-columns>
                  </ejs-grid>

                  <ng-template #dischargedActionsTemplate let-data>
                    <button class="e-btn e-small e-primary" (click)="viewFullHistory(data.patientID)">
                      <mat-icon>history</mat-icon>
                      View History
                    </button>
                  </ng-template>
                }

                <!-- Empty State -->
                @if (!loadingDischarged && filteredDischargedPatients.length === 0) {
                  <div class="empty-state">
                    <mat-icon>history</mat-icon>
                    <h3>No Discharged Patients Found</h3>
                  </div>
                }
              </div>
            </ng-template>
          </e-tabitem>
        </e-tabitems>
      </ejs-tab>
    </div>
  </div>
</div>
