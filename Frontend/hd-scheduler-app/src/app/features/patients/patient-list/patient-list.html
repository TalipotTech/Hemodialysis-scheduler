<div class="patient-list-container">
  <div class="e-card">
    <div class="e-card-header">
      <div class="e-card-header-title">
        <div class="header-row">
          <div class="header-left">
            <button class="e-btn e-icon-btn" (click)="goHome()" title="Home">
              <mat-icon>home</mat-icon>
            </button>
            <button class="e-btn e-icon-btn" (click)="goBack()" title="Back">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Patient Management</h2>
            <!-- Global Search Bar for All Registered Patients -->
            <div class="global-search-container">
              <input type="text" 
                     [(ngModel)]="globalSearchTerm" 
                     (input)="onGlobalSearch()" 
                     placeholder="Search all patients by name, MRN, or phone"
                     class="global-search-field">
            </div>
          </div>
          <div class="header-actions">
            @if (isReadOnly) {
              <span class="warning-chip">
                <mat-icon>lock</mat-icon>
                READ-ONLY ACCESS
              </span>
            }
            <button class="e-btn e-icon-btn refresh-button" (click)="onRefresh()" title="Refresh">
              <mat-icon>refresh</mat-icon>
            </button>
            @if (!isReadOnly) {
              <button class="e-btn e-primary" (click)="onAddPatient()">
                <mat-icon>add</mat-icon>
                Add New Patient
              </button>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="e-card-content">
      <!-- Global Search Results Overlay -->
      @if (showGlobalSearchResults) {
        <div class="global-search-results">
          <div class="search-results-header">
            <h3>Search Results ({{globalSearchResults.length}} patients)</h3>
            <button class="e-btn e-icon-btn" (click)="showGlobalSearchResults = false">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          @if (globalSearchResults.length > 0) {
            <ejs-grid
              [dataSource]="globalSearchResults"
              [allowPaging]="true"
              [allowSorting]="true"
              [pageSettings]="{ pageSize: 10 }"
              (rowDataBound)="onRowDataBound($event)">
              <e-columns>
                <e-column field="patientID" headerText="ID" width="70"></e-column>
                <e-column field="name" headerText="Name" width="150"></e-column>
                <e-column field="mrn" headerText="MRN" width="100"></e-column>
                <e-column field="age" headerText="Age" width="60"></e-column>
                <e-column field="gender" headerText="Gender" width="80"></e-column>
                <e-column field="contactNumber" headerText="Contact" width="120"></e-column>
                <e-column headerText="Actions" width="200" [template]="globalActionsTemplate"></e-column>
              </e-columns>
            </ejs-grid>
            
            <ng-template #globalActionsTemplate let-data>
              <div class="action-buttons">
                <button class="e-btn e-small e-info" (click)="onScheduleHD(data)" title="Schedule HD">
                  <mat-icon>event_available</mat-icon>
                </button>
                <button class="e-btn e-small e-primary" (click)="onEditPatient(data)" title="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button class="e-btn e-small e-info" (click)="onViewHistory(data)" title="History">
                  <mat-icon>history</mat-icon>
                </button>
              </div>
            </ng-template>
          } @else {
            <div class="empty-state">
              <mat-icon>search_off</mat-icon>
              <h3>No patients found</h3>
              <p>Try different search terms</p>
            </div>
          }
        </div>
      }

      <!-- Tabs Reordered: Pre Schedule, Active Patients, Completed Sessions, Discharged History -->
      <ejs-tab [selectedItem]="selectedTabIndex" (selected)="onTabChange($event.selectedIndex)">
        <e-tabitems>
          
          <!-- Tab 0: Pre Schedule -->
          <e-tabitem [header]="{'text': 'Pre Schedule'}">
            <ng-template #content>
              <div class="tab-content">
                <div class="section-header">
                  <h3><mat-icon>event</mat-icon> Pre Schedule (Pre-Scheduled & Future Sessions)</h3>
                  <p class="tab-description">Patients with upcoming dialysis sessions but no active treatment today.</p>
                </div>

                <!-- Status Legend -->
                <div class="status-legend">
                  <div class="legend-item">
                    <div class="legend-color legend-active"></div>
                    <span>üü¢ Active (In Treatment)</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color legend-late"></div>
                    <span>üü° Late (Running Late)</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color legend-missed"></div>
                    <span>üî¥ Missed (No-Show)</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color legend-rescheduled"></div>
                    <span>üîµ Rescheduled</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color legend-discharged"></div>
                    <span>‚ö´ Discharged</span>
                  </div>
                </div>

                <!-- Date Filter Chips -->
                <div class="filter-chips-container">
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedPreScheduleDateFilter === 'all'"
                          (click)="onPreScheduleDateFilterChange('all')"
                          class="filter-chip">
                    <mat-icon>all_inclusive</mat-icon>
                    All
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedPreScheduleDateFilter === 'today'"
                          (click)="onPreScheduleDateFilterChange('today')"
                          class="filter-chip">
                    <mat-icon>today</mat-icon>
                    Today
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedPreScheduleDateFilter === 'tomorrow'"
                          (click)="onPreScheduleDateFilterChange('tomorrow')"
                          class="filter-chip">
                    <mat-icon>event</mat-icon>
                    Tomorrow
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedPreScheduleDateFilter === 'thisweek'"
                          (click)="onPreScheduleDateFilterChange('thisweek')"
                          class="filter-chip">
                    <mat-icon>date_range</mat-icon>
                    This Week
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedPreScheduleDateFilter === 'thismonth'"
                          (click)="onPreScheduleDateFilterChange('thismonth')"
                          class="filter-chip">
                    <mat-icon>calendar_today</mat-icon>
                    This Month
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedPreScheduleDateFilter === 'custom'"
                          (click)="onPreScheduleDateFilterChange('custom')"
                          class="filter-chip">
                    <mat-icon>calendar_month</mat-icon>
                    Custom Date
                  </button>
                </div>

                <!-- Search -->
                <div class="search-container">
                  <input type="text" 
                         [(ngModel)]="reservedSearchTerm" 
                         (input)="onReservedSearch()" 
                         placeholder="Search pre-scheduled patients"
                         class="search-field">
                </div>

                <!-- Loading -->
                @if (loadingReserved) {
                  <div class="loading-container">
                    <div class="e-spinner-pane">
                      <div class="e-spinner-inner">
                        <div class="e-spin-material"></div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Reserved Grid - GROUPED VIEW for Today/Tomorrow -->
                @if (!loadingReserved && filteredReservedPatients.length > 0) {
                  
                  <!-- Actions Template for TODAY and TOMORROW - Define BEFORE grids -->
                  <ng-template #reservedActionsTemplate let-data>
                    <div class="action-buttons">
                      <!-- Activate Button - Only show if session is Pre-Scheduled -->
                      @if (data.sessionStatus === 'Pre-Scheduled' || !data.sessionStatus) {
                        <button class="e-btn e-small e-success" 
                                (click)="onActivateReservedPatient(data); $event.stopPropagation()" 
                                type="button"
                                title="Activate - Start Patient's Dialysis">
                          <mat-icon>play_arrow</mat-icon>
                        </button>
                      } @else {
                        <span class="status-badge active-status">
                          <mat-icon>check_circle</mat-icon>
                          Already Active
                        </span>
                      }
                      
                      <!-- Orange Warning Buttons for TODAY/TOMORROW -->
                      <button class="e-btn e-small e-warning" 
                              (click)="onMarkLate(data); $event.stopPropagation()" 
                              type="button"
                              title="Mark Late - Patient Running Late">
                        <mat-icon>schedule</mat-icon>
                      </button>
                      <button class="e-btn e-small e-warning" 
                              (click)="onReschedule(data); $event.stopPropagation()" 
                              type="button"
                              title="Reschedule - Change Appointment Time">
                        <mat-icon>event_repeat</mat-icon>
                      </button>
                      <button class="e-btn e-small e-danger" 
                              (click)="onMarkMissed(data); $event.stopPropagation()" 
                              type="button"
                              title="Missed - Mark as No-Show">
                        <mat-icon>cancel</mat-icon>
                      </button>
                      
                      <!-- Discharge Button - Stop dialysis permanently -->
                      <button class="e-btn e-small e-danger" 
                              (click)="onFullDischargePatient(data); $event.stopPropagation()" 
                              type="button"
                              title="Discharge - Stop Dialysis Program (Permanent)">
                        <mat-icon>delete_forever</mat-icon>
                      </button>
                      
                      <button class="e-btn e-small e-info" 
                              (click)="onViewReservedPatientHistory(data); $event.stopPropagation()" 
                              type="button"
                              title="History - View Patient Records">
                        <mat-icon>history</mat-icon>
                      </button>
                    </div>
                  </ng-template>
                  
                  <!-- Show GROUPED view for TODAY and TOMORROW -->
                  @if (selectedPreScheduleDateFilter === 'today' || selectedPreScheduleDateFilter === 'tomorrow') {
                    
                    <!-- Morning Slot -->
                    @if (groupedReservedPatients.morning.length > 0) {
                      <div class="time-slot-group">
                        <div class="slot-header morning-slot">
                          <mat-icon>wb_sunny</mat-icon>
                          <h3>‚òÄÔ∏è Morning (06:00 - 10:00) - {{ groupedReservedPatients.morning.length }} patients</h3>
                          <span class="bed-stats">Beds: {{ slotStatistics.morning.used }}/{{ slotStatistics.morning.total }}</span>
                        </div>
                        <ejs-grid
                          [dataSource]="groupedReservedPatients.morning"
                          [allowPaging]="false"
                          [allowSorting]="true"
                          (rowDataBound)="onRowDataBound($event)">
                          <e-columns>
                            <e-column field="patientId" headerText="ID" width="70"></e-column>
                            <e-column field="name" headerText="Patient Name" width="150"></e-column>
                            <e-column field="mrn" headerText="MRN" width="100"></e-column>
                            <e-column field="bedNumber" headerText="Bed" width="80"></e-column>
                            <e-column field="age" headerText="Age" width="60"></e-column>
                            <e-column field="gender" headerText="Gender" width="80"></e-column>
                            <e-column field="hdCycle" headerText="HD Cycle" width="150"></e-column>
                            <e-column field="futureSessionsCount" headerText="Future Sessions" width="120"></e-column>
                            <e-column field="nextScheduledDay" headerText="Next Session" width="150"></e-column>
                            <e-column headerText="Actions" width="280" [template]="reservedActionsTemplate"></e-column>
                          </e-columns>
                        </ejs-grid>
                      </div>
                    }

                    <!-- Afternoon Slot -->
                    @if (groupedReservedPatients.afternoon.length > 0) {
                      <div class="time-slot-group">
                        <div class="slot-header afternoon-slot">
                          <mat-icon>wb_sunny</mat-icon>
                          <h3>üå§Ô∏è Afternoon (11:00 - 15:00) - {{ groupedReservedPatients.afternoon.length }} patients</h3>
                          <span class="bed-stats">Beds: {{ slotStatistics.afternoon.used }}/{{ slotStatistics.afternoon.total }}</span>
                        </div>
                        <ejs-grid
                          [dataSource]="groupedReservedPatients.afternoon"
                          [allowPaging]="false"
                          [allowSorting]="true"
                          (rowDataBound)="onRowDataBound($event)">
                          <e-columns>
                            <e-column field="patientId" headerText="ID" width="70"></e-column>
                            <e-column field="name" headerText="Patient Name" width="150"></e-column>
                            <e-column field="mrn" headerText="MRN" width="100"></e-column>
                            <e-column field="bedNumber" headerText="Bed" width="80"></e-column>
                            <e-column field="age" headerText="Age" width="60"></e-column>
                            <e-column field="gender" headerText="Gender" width="80"></e-column>
                            <e-column field="hdCycle" headerText="HD Cycle" width="150"></e-column>
                            <e-column field="futureSessionsCount" headerText="Future Sessions" width="120"></e-column>
                            <e-column field="nextScheduledDay" headerText="Next Session" width="150"></e-column>
                            <e-column headerText="Actions" width="280" [template]="reservedActionsTemplate"></e-column>
                          </e-columns>
                        </ejs-grid>
                      </div>
                    }

                    <!-- Evening Slot -->
                    @if (groupedReservedPatients.evening.length > 0) {
                      <div class="time-slot-group">
                        <div class="slot-header evening-slot">
                          <mat-icon>brightness_3</mat-icon>
                          <h3>üåÜ Evening (16:00 - 20:00) - {{ groupedReservedPatients.evening.length }} patients</h3>
                          <span class="bed-stats">Beds: {{ slotStatistics.evening.used }}/{{ slotStatistics.evening.total }}</span>
                        </div>
                        <ejs-grid
                          [dataSource]="groupedReservedPatients.evening"
                          [allowPaging]="false"
                          [allowSorting]="true"
                          (rowDataBound)="onRowDataBound($event)">
                          <e-columns>
                            <e-column field="patientId" headerText="ID" width="70"></e-column>
                            <e-column field="name" headerText="Patient Name" width="150"></e-column>
                            <e-column field="mrn" headerText="MRN" width="100"></e-column>
                            <e-column field="bedNumber" headerText="Bed" width="80"></e-column>
                            <e-column field="age" headerText="Age" width="60"></e-column>
                            <e-column field="gender" headerText="Gender" width="80"></e-column>
                            <e-column field="hdCycle" headerText="HD Cycle" width="150"></e-column>
                            <e-column field="futureSessionsCount" headerText="Future Sessions" width="120"></e-column>
                            <e-column field="nextScheduledDay" headerText="Next Session" width="150"></e-column>
                            <e-column headerText="Actions" width="280" [template]="reservedActionsTemplate"></e-column>
                          </e-columns>
                        </ejs-grid>
                      </div>
                    }

                    <!-- Night Slot -->
                    <div class="time-slot-group">
                      <div class="slot-header night-slot">
                        <mat-icon>bedtime</mat-icon>
                        <h3>üåô Night (21:00 - 01:00) - {{ groupedReservedPatients.night.length }} patients</h3>
                        <span class="bed-stats">Beds: {{ slotStatistics.night.used }}/{{ slotStatistics.night.total }}</span>
                      </div>
                      @if (groupedReservedPatients.night.length > 0) {
                        <ejs-grid
                          [dataSource]="groupedReservedPatients.night"
                          [allowPaging]="false"
                          [allowSorting]="true"
                          (rowDataBound)="onRowDataBound($event)">
                          <e-columns>
                            <e-column field="patientId" headerText="ID" width="70"></e-column>
                            <e-column field="name" headerText="Patient Name" width="150"></e-column>
                            <e-column field="mrn" headerText="MRN" width="100"></e-column>
                            <e-column field="bedNumber" headerText="Bed" width="80"></e-column>
                            <e-column field="age" headerText="Age" width="60"></e-column>
                            <e-column field="gender" headerText="Gender" width="80"></e-column>
                            <e-column field="hdCycle" headerText="HD Cycle" width="150"></e-column>
                            <e-column field="futureSessionsCount" headerText="Future Sessions" width="120"></e-column>
                            <e-column field="nextScheduledDay" headerText="Next Session" width="150"></e-column>
                            <e-column headerText="Actions" width="280" [template]="reservedActionsTemplate"></e-column>
                          </e-columns>
                        </ejs-grid>
                      } @else {
                        <div class="empty-slot-message">
                          <mat-icon>event_available</mat-icon>
                          <p>No patients scheduled for night shift</p>
                        </div>
                      }
                    </div>

                    <!-- Unassigned Slot -->
                    <div class="time-slot-group">
                      <div class="slot-header unassigned-slot">
                        <mat-icon>help_outline</mat-icon>
                        <h3>‚ùì Unassigned Time Slot ({{ groupedReservedPatients.unassigned.length }} patients)</h3>
                        <span class="bed-stats">No time slot assigned</span>
                      </div>
                      @if (groupedReservedPatients.unassigned.length > 0) {
                        <ejs-grid
                          [dataSource]="groupedReservedPatients.unassigned"
                          [allowPaging]="false"
                          [allowSorting]="true"
                          (rowDataBound)="onRowDataBound($event)">
                          <e-columns>
                            <e-column field="patientId" headerText="ID" width="70"></e-column>
                            <e-column field="name" headerText="Patient Name" width="150"></e-column>
                            <e-column field="mrn" headerText="MRN" width="100"></e-column>
                            <e-column field="bedNumber" headerText="Bed" width="80"></e-column>
                            <e-column field="age" headerText="Age" width="60"></e-column>
                            <e-column field="gender" headerText="Gender" width="80"></e-column>
                            <e-column field="hdCycle" headerText="HD Cycle" width="150"></e-column>
                            <e-column field="futureSessionsCount" headerText="Future Sessions" width="120"></e-column>
                            <e-column field="nextScheduledDay" headerText="Next Session" width="150"></e-column>
                            <e-column headerText="Actions" width="280" [template]="reservedActionsTemplate"></e-column>
                          </e-columns>
                        </ejs-grid>
                      } @else {
                        <div class="empty-slot-message">
                          <mat-icon>check_circle</mat-icon>
                          <p>All patients have time slots assigned</p>
                        </div>
                      }
                    </div>
                  
                  } @else {
                    <!-- Show FLAT view for other filters (All, This Week, This Month, Custom) -->
                    <ejs-grid
                      [dataSource]="filteredReservedPatients"
                      [allowPaging]="true"
                      [allowSorting]="true"
                      [allowFiltering]="true"
                      [pageSettings]="{ pageSize: 20, pageSizes: [10, 20, 50] }"
                      (rowDataBound)="onRowDataBound($event)">
                      
                      <e-columns>
                        <e-column field="patientId" headerText="ID" width="70"></e-column>
                        <e-column field="name" headerText="Patient Name" width="150"></e-column>
                        <e-column field="mrn" headerText="MRN" width="100"></e-column>
                        <e-column field="age" headerText="Age" width="60"></e-column>
                        <e-column field="gender" headerText="Gender" width="80"></e-column>
                        <e-column field="hdCycle" headerText="HD Cycle" width="150"></e-column>
                        <e-column field="futureSessionsCount" headerText="Future Sessions" width="120"></e-column>
                        <e-column field="nextScheduledDay" headerText="Next Session" width="150"></e-column>
                        <e-column 
                          headerText="Actions" 
                          width="250" 
                          [template]="flatActionsTemplate">
                        </e-column>
                      </e-columns>
                    </ejs-grid>

                    <ng-template #flatActionsTemplate let-data>
                      <div class="action-buttons">
                        <button class="e-btn e-small e-success" 
                                (click)="onActivateReservedPatient(data)" 
                                title="Activate - Start Patient's Dialysis">
                          <mat-icon>play_arrow</mat-icon>
                        </button>
                        <button class="e-btn e-small e-info" 
                                (click)="onViewReservedPatientHistory(data)" 
                                title="History - View Patient Records">
                          <mat-icon>history</mat-icon>
                        </button>
                        <button class="e-btn e-small e-primary" 
                                (click)="onEditPatient(data)" 
                                title="Edit Patient Details">
                          <mat-icon>edit</mat-icon>
                        </button>
                      </div>
                    </ng-template>
                  }
                }

                <!-- Empty State -->
                @if (!loadingReserved && filteredReservedPatients.length === 0) {
                  <div class="empty-state">
                    <mat-icon>event_busy</mat-icon>
                    <h3>No Pre-Scheduled Patients Found</h3>
                    <p>Pre-scheduled patients have future scheduled sessions but no active treatment today</p>
                  </div>
                }
              </div>
            </ng-template>
          </e-tabitem>

          <!-- Tab 1: Active Patients (TODAY'S SESSIONS ONLY) -->
          <e-tabitem [header]="{'text': 'Active Patients'}">
            <ng-template #content>
              <div class="tab-content">
                <div class="section-header">
                  <h3><mat-icon>person</mat-icon> Active Patients (Today's Sessions)</h3>
                  <p class="tab-description">Patients with active dialysis sessions scheduled for TODAY only.</p>
                </div>
                
                <!-- Search Bar -->
                <div class="search-container">
                  <input type="text" 
                         [(ngModel)]="searchTerm" 
                         (input)="onSearch()" 
                         placeholder="Search by name, MRN, or phone"
                         class="search-field">
                </div>

                <!-- Loading -->
                @if (loading) {
                  <div class="loading-container">
                    <div class="e-spinner-pane">
                      <div class="e-spinner-inner">
                        <div class="e-spin-material"></div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Error Message -->
                @if (errorMessage && !loading) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    {{ errorMessage }}
                  </div>
                }

                <!-- Active Patients Grid (TODAY'S SESSIONS ONLY) -->
                @if (!loading && !errorMessage && filteredPatients.length > 0) {
                  <ejs-grid
                    [dataSource]="filteredPatients"
                    [allowPaging]="true"
                    [allowSorting]="true"
                    [allowFiltering]="true"
                    [pageSettings]="{ pageSize: 20, pageSizes: [10, 20, 50, 100] }"
                    [filterSettings]="{ type: 'Excel' }"
                    (rowDataBound)="onRowDataBound($event)">
                    
                    <e-columns>
                      <e-column field="patientID" headerText="ID" width="70"></e-column>
                      <e-column 
                        field="name" 
                        headerText="Patient Name" 
                        width="150"
                        [template]="nameTemplate">
                      </e-column>
                      <e-column field="mrn" headerText="MRN" width="100"></e-column>
                      <e-column field="age" headerText="Age" width="60"></e-column>
                      <e-column field="gender" headerText="Gender" width="80"></e-column>
                      <e-column 
                        headerText="Session Progress" 
                        width="150" 
                        [template]="sessionProgressTemplate">
                      </e-column>
                      <e-column field="contactNumber" headerText="Contact" width="120"></e-column>
                      <e-column 
                        headerText="Actions" 
                        width="400" 
                        [template]="actionsTemplate">
                      </e-column>
                    </e-columns>
                  </ejs-grid>

                  <!-- Patient Name Template with Hover Info -->
                  <ng-template #nameTemplate let-data>
                    <div class="patient-name-cell clickable" 
                         (click)="openPatientInfoDialog(data)"
                         [matTooltip]="'Click to view patient details'" 
                         matTooltipClass="patient-info-tooltip"
                         matTooltipPosition="right">
                      <mat-icon class="info-icon">info</mat-icon>
                      {{ data.name }}
                    </div>
                  </ng-template>

                  <!-- Session Progress Template -->
                  <ng-template #sessionProgressTemplate let-data>
                    <div class="session-progress-cell">
                      <div class="progress-info">
                        <span class="progress-text">{{ data.totalDialysisCompleted || 0 }} sessions</span>
                        @if (data.sessionStatus === 'Completed') {
                          <span class="completed-badge">‚úÖ Completed</span>
                        }
                        @if (isLastSession(data) && data.sessionStatus !== 'Completed') {
                          <span class="last-session-badge">‚ö†Ô∏è LAST</span>
                        }
                      </div>
                    </div>
                  </ng-template>

                  <!-- Actions Template -->
                  <ng-template #actionsTemplate let-data>
                    <div class="action-buttons">
                      <button class="e-btn e-small e-info" (click)="onScheduleHD(data)" [disabled]="data.isDischarged" title="Schedule HD">
                        <mat-icon>event_available</mat-icon>
                      </button>
                      <button class="e-btn e-small e-success" (click)="onQuickSchedule(data)" [disabled]="data.isDischarged" title="AI Quick">
                        <mat-icon>psychology</mat-icon>
                      </button>
                      <button class="e-btn e-small e-info" (click)="onViewHistory(data)" title="History">
                        <mat-icon>history</mat-icon>
                      </button>
                      @if (!isReadOnly) {
                        <button class="e-btn e-small e-primary" (click)="onEditPatient(data)" title="Edit">
                          <mat-icon>edit</mat-icon>
                        </button>
                        <!-- Complete Session Button - Marks today's dialysis as complete -->
                        <button class="e-btn e-small e-success" 
                                (click)="onCompleteSession(data)" 
                                [title]="getCompleteSessionButtonTitle(data)"
                                [class.pulse-warning]="isLastSession(data)">
                          <mat-icon>check_circle</mat-icon>
                        </button>
                      }
                    </div>
                  </ng-template>
                }

                <!-- Empty State -->
                @if (!loading && !errorMessage && filteredPatients.length === 0) {
                  <div class="empty-state">
                    <mat-icon>event_busy</mat-icon>
                    <h3>No Active Patients Today</h3>
                    <p>No patients have been activated/scheduled for today's dialysis sessions.</p>
                    <p class="note">Activate patients from the Pre-Schedule tab or schedule new sessions to see them here.</p>
                  </div>
                }
              </div>
            </ng-template>
          </e-tabitem>

          <!-- Tab 2: Completed Sessions -->
          <e-tabitem [header]="{'text': 'Completed Sessions'}">
            <ng-template #content>
              <div class="tab-content">
                <div class="section-header">
                  <h3><mat-icon>check_circle</mat-icon> Completed Sessions</h3>
                  <p class="tab-description">View completed dialysis sessions by date range</p>
                </div>

                <!-- Date Filter Chips -->
                <div class="filter-chips-container">
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedDateFilter === 'today'"
                          (click)="onDateFilterChange('today')"
                          class="filter-chip">
                    <mat-icon>today</mat-icon>
                    Today
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedDateFilter === 'last24h'"
                          (click)="onDateFilterChange('last24h')"
                          class="filter-chip">
                    <mat-icon>schedule</mat-icon>
                    Last 24h
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedDateFilter === 'yesterday'"
                          (click)="onDateFilterChange('yesterday')"
                          class="filter-chip">
                    <mat-icon>event</mat-icon>
                    Yesterday
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedDateFilter === 'last7days'"
                          (click)="onDateFilterChange('last7days')"
                          class="filter-chip">
                    <mat-icon>date_range</mat-icon>
                    Last 7 Days
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedDateFilter === 'thismonth'"
                          (click)="onDateFilterChange('thismonth')"
                          class="filter-chip">
                    <mat-icon>calendar_today</mat-icon>
                    This Month
                  </button>
                  <button mat-stroked-button 
                          [class.filter-chip-selected]="selectedDateFilter === 'custom'"
                          (click)="onDateFilterChange('custom')"
                          class="filter-chip">
                    <mat-icon>calendar_month</mat-icon>
                    Custom Date
                  </button>
                </div>

                <!-- Search -->
                <div class="search-container">
                  <input type="text" 
                         [(ngModel)]="completedSearchTerm" 
                         (input)="onCompletedSearch()" 
                         placeholder="Search completed sessions"
                         class="search-field">
                </div>

                <!-- Loading -->
                @if (loadingCompleted) {
                  <div class="loading-container">
                    <div class="e-spinner-pane">
                      <div class="e-spinner-inner">
                        <div class="e-spin-material"></div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Completed Grid -->
                @if (!loadingCompleted && filteredCompletedSessions.length > 0) {
                  <ejs-grid
                    [dataSource]="filteredCompletedSessions"
                    [allowPaging]="true"
                    [allowSorting]="true"
                    [allowFiltering]="true"
                    [pageSettings]="{ pageSize: 20, pageSizes: [10, 20, 50] }"
                    (rowDataBound)="onRowDataBound($event)">
                    
                    <e-columns>
                      <e-column field="patientID" headerText="ID" width="70"></e-column>
                      <e-column field="name" headerText="Patient Name" width="150"></e-column>
                      <e-column field="mrn" headerText="MRN" width="100"></e-column>
                      <e-column field="age" headerText="Age" width="60"></e-column>
                      <e-column field="gender" headerText="Gender" width="80"></e-column>
                      <e-column 
                        headerText="Session Progress" 
                        width="150" 
                        [template]="completedSessionProgressTemplate">
                      </e-column>
                      <e-column field="contactNumber" headerText="Contact" width="120"></e-column>
                      <e-column 
                        headerText="Actions" 
                        width="250" 
                        [template]="completedActionsTemplate">
                      </e-column>
                    </e-columns>
                  </ejs-grid>

                  <!-- Completed Session Progress Template -->
                  <ng-template #completedSessionProgressTemplate let-data>
                    <div class="session-progress-cell">
                      <div class="progress-info">
                        <span class="progress-text">{{ data.totalDialysisCompleted || 0 }} sessions</span>
                        <span class="completed-badge">‚úÖ Done</span>
                      </div>
                    </div>
                  </ng-template>

                  <!-- Completed Actions Template -->
                  <ng-template #completedActionsTemplate let-data>
                    <div class="action-buttons">
                      <button class="e-btn e-small e-info" 
                              (click)="onViewHistory(data)" 
                              title="History - View All Session Details">
                        <mat-icon>history</mat-icon>
                      </button>
                      @if (!isReadOnly && isLastSession(data)) {
                        <button class="e-btn e-small e-danger" 
                                (click)="onFullDischargePatient(data)" 
                                title="Discharge - Remove Patient from Active Program (Last Session)"
                                style="background: linear-gradient(135deg, #ff6b6b, #ff8787) !important; font-weight: 600;">
                          <mat-icon>logout</mat-icon>
                        </button>
                      }
                    </div>
                  </ng-template>
                }

                <!-- Empty State -->
                @if (!loadingCompleted && filteredCompletedSessions.length === 0) {
                  <div class="empty-state">
                    <mat-icon>event_available</mat-icon>
                    <h3>No Completed Sessions</h3>
                    <p>No patients have completed dialysis sessions for the selected date range</p>
                  </div>
                }
              </div>
            </ng-template>
          </e-tabitem>

          <!-- Tab 3: Discharged History -->
          <e-tabitem [header]="{'text': 'Discharged History'}">
            <ng-template #content>
              <div class="tab-content">
                <div class="tab-header">
                  <h3><mat-icon>history</mat-icon> Discharged Patients Treatment History</h3>
                </div>

                <!-- Search -->
                <div class="search-container">
                  <input type="text" 
                         [(ngModel)]="dischargedSearchTerm" 
                         (input)="onDischargedSearch()" 
                         placeholder="Search discharged patients"
                         class="search-field">
                </div>

                <!-- Loading -->
                @if (loadingDischarged) {
                  <div class="loading-container">
                    <div class="e-spinner-pane">
                      <div class="e-spinner-inner">
                        <div class="e-spin-material"></div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Discharged Grid -->
                @if (!loadingDischarged && filteredDischargedPatients.length > 0) {
                  <ejs-grid
                    [dataSource]="filteredDischargedPatients"
                    [allowPaging]="true"
                    [allowSorting]="true"
                    [allowFiltering]="true"
                    [pageSettings]="{ pageSize: 10 }"
                    (rowDataBound)="onRowDataBound($event)">
                    
                    <e-columns>
                      <e-column field="patientID" headerText="ID" width="70"></e-column>
                      <e-column field="name" headerText="Name" width="150"></e-column>
                      <e-column field="mrn" headerText="MRN" width="100"></e-column>
                      <e-column field="age" headerText="Age" width="60"></e-column>
                      <e-column field="totalDialysisCompleted" headerText="Sessions" width="100"></e-column>
                      <e-column 
                        headerText="Actions" 
                        width="150" 
                        [template]="dischargedActionsTemplate">
                      </e-column>
                    </e-columns>
                  </ejs-grid>

                  <ng-template #dischargedActionsTemplate let-data>
                    <button class="e-btn e-small e-primary" (click)="viewFullHistory(data.patientID)">
                      <mat-icon>history</mat-icon>
                      View History
                    </button>
                  </ng-template>
                }

                <!-- Empty State -->
                @if (!loadingDischarged && filteredDischargedPatients.length === 0) {
                  <div class="empty-state">
                    <mat-icon>history</mat-icon>
                    <h3>No Discharged Patients Found</h3>
                  </div>
                }
              </div>
            </ng-template>
          </e-tabitem>
        </e-tabitems>
      </ejs-tab>
    </div>
  </div>
</div>
