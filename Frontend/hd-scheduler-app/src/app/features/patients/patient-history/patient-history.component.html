<div class="patient-history-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <div class="header-row">
          <div class="header-left">
            <button mat-icon-button (click)="goHome()" class="home-button" matTooltip="Home">
              <mat-icon>home</mat-icon>
            </button>
            <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Back">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Patient Treatment History</h2>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if (loading) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      }

      @if (errorMessage && !loading) {
        <div class="error-message">
          <mat-icon>error</mat-icon>
          {{ errorMessage }}
        </div>
      }

      @if (!loading && !errorMessage && patientInfo) {
        <!-- Patient Info Summary -->
        <div class="patient-summary">
          <h3><mat-icon>person</mat-icon> Patient Information</h3>
          <div class="info-grid">
            <div class="info-item">
              <mat-icon>person</mat-icon>
              <div>
                <label>Patient Name</label>
                <span>{{ patientInfo.name }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>badge</mat-icon>
              <div>
                <label>Patient ID</label>
                <span>{{ patientInfo.patientID }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>badge</mat-icon>
              <div>
                <label>MRN</label>
                <span>{{ patientInfo.mrn || 'Not Assigned' }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>calendar_today</mat-icon>
              <div>
                <label>Age</label>
                <span>{{ patientInfo.age ? (patientInfo.age + ' years') : 'N/A' }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>wc</mat-icon>
              <div>
                <label>Gender</label>
                <span>{{ patientInfo.gender }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>monitor_weight</mat-icon>
              <div>
                <label>Dry Weight</label>
                <span>{{ patientInfo.dryWeight ? (patientInfo.dryWeight + ' kg') : 'N/A' }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>event</mat-icon>
              <div>
                <label>HD Cycle</label>
                <span>{{ patientInfo.hdCycle || 'N/A' }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>calendar_today</mat-icon>
              <div>
                <label>HD Start Date</label>
                <span>{{ patientInfo.hdStartDate ? (patientInfo.hdStartDate | date:'MMM d, y') : 'N/A' }}</span>
              </div>
            </div>
            <div class="info-item">
              <mat-icon>science</mat-icon>
              <div>
                <label>Dialyser Type</label>
                <span>{{ patientInfo.dialyserType || 'N/A' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Equipment Usage & Purchase Tracking -->
        <div class="equipment-tracking-card">
          <h3><mat-icon>build_circle</mat-icon> Equipment Usage & Purchase History</h3>
          <div class="equipment-grid">
            <div class="equipment-item dialyser">
              <div class="equipment-header">
                <mat-icon>water_drop</mat-icon>
                <h4>Dialyser</h4>
              </div>
              <div class="equipment-details">
                <div class="current-usage">
                  <label>Current Usage:</label>
                  <span class="usage-value">{{ patientInfo.dialyserCount || 0 }} / 7</span>
                  <mat-progress-bar mode="determinate" [value]="getUsagePercentage(patientInfo.dialyserCount || 0, 7)"></mat-progress-bar>
                </div>
                <div class="purchase-count">
                  <label>Total Purchased:</label>
                  <span class="purchase-value">{{ patientInfo.dialysersPurchased || 0 }}</span>
                </div>
              </div>
            </div>
            
            <div class="equipment-item tubing">
              <div class="equipment-header">
                <mat-icon>line_style</mat-icon>
                <h4>Blood Tubing</h4>
              </div>
              <div class="equipment-details">
                <div class="current-usage">
                  <label>Current Usage:</label>
                  <span class="usage-value">{{ patientInfo.bloodTubingCount || 0 }} / 12</span>
                  <mat-progress-bar mode="determinate" [value]="getUsagePercentage(patientInfo.bloodTubingCount || 0, 12)"></mat-progress-bar>
                </div>
                <div class="purchase-count">
                  <label>Total Purchased:</label>
                  <span class="purchase-value">{{ patientInfo.bloodTubingPurchased || 0 }}</span>
                </div>
              </div>
            </div>

            <div class="equipment-item sessions">
              <div class="equipment-header">
                <mat-icon>event_available</mat-icon>
                <h4>Dialysis Sessions</h4>
              </div>
              <div class="equipment-details">
                <div class="sessions-completed">
                  <label>Total Completed:</label>
                  <span class="sessions-value">{{ patientInfo.totalDialysisCompleted || 0 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Summary -->
        @if (statistics) {
          <div class="statistics-card">
            <h3>Session Summary</h3>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value">{{ statistics.totalSessions }}</div>
                <div class="stat-label">Total Sessions</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.firstSessionDate | date:'MMM d, y' }}</div>
                <div class="stat-label">First Session</div>
              </div>
            </div>
          </div>
        }

        <!-- Tabs for different views -->
        <mat-tab-group class="history-tabs">
          <!-- Timeline Tab -->
          <mat-tab label="Session Timeline">
            <div class="tab-content">
              <!-- Combined Timeline: Sessions + Activities -->
              @if (timeline && timeline.length > 0) {
                <div class="unified-timeline">
                  <div class="timeline-header">
                    <h3>
                      <mat-icon>timeline</mat-icon>
                      Complete Patient History
                    </h3>
                    <p class="timeline-subtitle">
                      Sessions, late arrivals, missed appointments, rescheduling, and discharge records
                    </p>
                  </div>

                  @for (event of timeline; track event.date) {
                    <div class="timeline-event" [class]="'event-' + getEventColor(event.eventType)">
                      <div class="timeline-marker">
                        <mat-icon [class]="'icon-' + getEventColor(event.eventType)">
                          {{ getEventIcon(event.eventType) }}
                        </mat-icon>
                      </div>
                      
                      <div class="timeline-content">
                        <div class="timeline-header-row">
                          <div class="timeline-date">
                            <mat-icon>calendar_today</mat-icon>
                            {{ event.date | date:'EEEE, MMMM d, y' }}
                          </div>
                          <mat-chip [class]="'chip-' + getEventColor(event.eventType)">
                            {{ getEventLabel(event.eventType) }}
                          </mat-chip>
                        </div>

                        <div class="timeline-details">
                          <!-- Session Completed -->
                          @if (event.eventType === 'SESSION_COMPLETED') {
                            <div class="event-info">
                              <mat-icon>event_available</mat-icon>
                              <span>{{ event.slotName }} - Bed {{ event.bedNumber }}</span>
                            </div>
                            @if (event.details) {
                              <p class="event-description">{{ event.details }}</p>
                            }
                          }

                          <!-- Missed Appointment -->
                          @if (event.eventType === 'MISSED') {
                            <div class="event-info alert-info">
                              <mat-icon>warning</mat-icon>
                              <span><strong>Reason:</strong> {{ event.reason || 'No-Show' }}</span>
                            </div>
                            @if (event.details) {
                              <p class="event-description">{{ event.details }}</p>
                            }
                            @if (event.recordedBy) {
                              <p class="recorded-by">
                                <mat-icon>person</mat-icon>
                                Recorded by: {{ event.recordedBy }}
                              </p>
                            }
                          }

                          <!-- Late Arrival -->
                          @if (event.eventType === 'LATE') {
                            <div class="event-info warning-info">
                              <mat-icon>access_time</mat-icon>
                              <span><strong>Reason:</strong> {{ event.reason || 'Running late' }}</span>
                            </div>
                            @if (event.details) {
                              <p class="event-description">{{ event.details }}</p>
                            }
                            @if (event.recordedBy) {
                              <p class="recorded-by">
                                <mat-icon>person</mat-icon>
                                Recorded by: {{ event.recordedBy }}
                              </p>
                            }
                          }

                          <!-- Rescheduled -->
                          @if (event.eventType === 'RESCHEDULED') {
                            <div class="event-info info-info">
                              <mat-icon>swap_horiz</mat-icon>
                              <span><strong>Reason:</strong> {{ event.reason || 'Rescheduled by request' }}</span>
                            </div>
                            @if (event.details) {
                              <p class="event-description">{{ event.details }}</p>
                            }
                            @if (event.recordedBy) {
                              <p class="recorded-by">
                                <mat-icon>person</mat-icon>
                                Recorded by: {{ event.recordedBy }}
                              </p>
                            }
                          }

                          <!-- Discharged -->
                          @if (event.eventType === 'DISCHARGED') {
                            <div class="event-info discharge-info">
                              <mat-icon>exit_to_app</mat-icon>
                              <span><strong>Reason:</strong> {{ event.reason || 'Discharged from program' }}</span>
                            </div>
                            @if (event.details) {
                              <p class="event-description">{{ event.details }}</p>
                            }
                            @if (event.recordedBy) {
                              <p class="recorded-by">
                                <mat-icon>person</mat-icon>
                                Recorded by: {{ event.recordedBy }}
                              </p>
                            }
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="no-data-message">
                  <mat-icon>history</mat-icon>
                  <p>No history records found</p>
                </div>
              }

              <!-- Legacy Sessions View (Keep for detailed session data) -->
              @if (sessions && sessions.length > 0) {
                <div class="sessions-timeline">
                  <h3 style="margin-top: 40px; color: #666;">
                    <mat-icon>event_note</mat-icon>
                    Detailed Session Records
                  </h3>
                  @for (session of sessions; track (session.scheduleID || session.ScheduleID)) {
                    <mat-expansion-panel class="session-panel">
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon>event</mat-icon>
                          <span>{{ session.sessionDate | date:'EEEE, MMMM d, y' }}</span>
                          @if (session.isMissed) {
                            <span class="missed-appointment-indicator">
                              <mat-icon>event_busy</mat-icon>
                              MISSED
                            </span>
                          } @else {
                            <mat-chip [class]="getStatusClass(session.isDischarged)">
                              {{ session.isDischarged ? 'Completed' : 'Active' }}
                            </mat-chip>
                          }
                        </mat-panel-title>
                        <mat-panel-description>
                          @if (session.isMissed) {
                            <span>Reason: {{ session.missedReason || 'Not specified' }}</span>
                          } @else {
                            {{ session.slotName }} - Bed {{ session.bedNumber }}
                          }
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      <div class="session-details">
                        @if (session.isMissed) {
                          <!-- Missed Appointment Details -->
                          <div class="missed-details-section">
                            <h4><mat-icon>warning</mat-icon> Missed Appointment Information</h4>
                            <div class="detail-grid">
                              <div class="detail-item">
                                <label>Reason:</label>
                                <span>{{ session.missedReason || 'Not specified' }}</span>
                              </div>
                              <div class="detail-item">
                                <label>Marked Date:</label>
                                <span>{{ session.missedDateTime | date:'MMM d, y h:mm a' }}</span>
                              </div>
                              @if (session.missedNotes) {
                                <div class="detail-item full-width">
                                  <label>Notes:</label>
                                  <span>{{ session.missedNotes }}</span>
                                </div>
                              }
                              @if (session.missedResolvedDateTime) {
                                <div class="detail-item">
                                  <label>Resolved Date:</label>
                                  <span>{{ session.missedResolvedDateTime | date:'MMM d, y h:mm a' }}</span>
                                </div>
                                @if (session.missedResolutionNotes) {
                                  <div class="detail-item full-width">
                                    <label>Resolution Notes:</label>
                                    <span>{{ session.missedResolutionNotes }}</span>
                                  </div>
                                }
                              }
                            </div>
                          </div>
                        } @else {
                          <!-- Normal Session Details -->
                        <div class="detail-grid">
                          <!-- HD Prescription & Treatment Plan -->
                          <div class="detail-section">
                            <h4><mat-icon>medical_services</mat-icon> HD Prescription & Treatment Plan</h4>
                            <p><strong>Treatment Date:</strong> {{ session.sessionDate | date:'MMM d, y' }}</p>
                            <p><strong>Time Slot:</strong> {{ session.slotName || 'N/A' }}</p>
                            <p><strong>Bed Number:</strong> {{ session.bedNumber || 'N/A' }}</p>
                          </div>

                          <!-- Vascular Access -->
                          <div class="detail-section">
                            <h4><mat-icon>accessible</mat-icon> Vascular Access</h4>
                            <p><strong>Access Type:</strong> {{ session.accessType || session.AccessType || 'N/A' }}</p>
                            <p><strong>Access Location:</strong> {{ session.accessLocation || session.AccessLocation || 'N/A' }}</p>
                          </div>

                          <!-- Anticoagulation -->
                          <div class="detail-section">
                            <h4><mat-icon>water_drop</mat-icon> Anticoagulation</h4>
                            <p><strong>Anticoagulation Type:</strong> {{ session.anticoagulationType || session.AnticoagulationType || 'N/A' }}</p>
                            <p><strong>Syringe Type:</strong> {{ session.syringeType || session.SyringeType || 'N/A' }}</p>
                            <p><strong>Bolus Dose:</strong> {{ session.bolusDose || session.BolusDose || 'N/A' }} {{ (session.bolusDose || session.BolusDose) ? 'mL' : '' }}</p>
                          </div>

                          <!-- Treatment Session Details -->
                          <div class="detail-section">
                            <h4><mat-icon>schedule</mat-icon> Treatment Session Details</h4>
                            <p><strong>Start Time:</strong> {{ session.startTime || session.StartTime || 'N/A' }}</p>
                            <p><strong>Pre-Weight:</strong> {{ session.preWeight || session.PreWeight || 'N/A' }} {{ (session.preWeight || session.PreWeight) ? 'kg' : '' }}</p>
                            <p><strong>UF Goal:</strong> {{ session.ufGoal || session.UFGoal || 'N/A' }} {{ (session.ufGoal || session.UFGoal) ? 'L' : '' }}</p>
                            <p><strong>Blood Pressure:</strong> {{ session.bloodPressure || session.BloodPressure || 'N/A' }}</p>
                          </div>

                          <!-- Intra-Dialytic Monitoring -->
                          <div class="detail-section highlight-section">
                            <h4><mat-icon>monitor_heart</mat-icon> Intra-Dialytic Monitoring</h4>
                            @if ((session.intraDialyticRecordsCount || session.IntraDialyticRecordsCount) && (session.intraDialyticRecordsCount || session.IntraDialyticRecordsCount) > 0) {
                              <p><strong>Monitoring Records:</strong> {{ session.intraDialyticRecordsCount || session.IntraDialyticRecordsCount }} record(s) captured during treatment</p>
                              <p class="note-text"><em>Click "View Full Details" to see complete monitoring records</em></p>
                            } @else {
                              <p class="note-text"><em>No monitoring records captured during this session</em></p>
                            }
                          </div>

                          <!-- Post-Dialysis Medications -->
                          @if (session.medicationName || session.MedicationName || session.medicationType || session.MedicationType) {
                            <div class="detail-section highlight-section medication-section">
                              <h4><mat-icon>local_pharmacy</mat-icon> Post-Dialysis Medications</h4>
                              <p><strong>Medication Type:</strong> {{ session.medicationType || session.MedicationType || 'N/A' }}</p>
                              <p><strong>Medication Name:</strong> {{ session.medicationName || session.MedicationName || 'N/A' }}</p>
                              <p><strong>Dose:</strong> {{ session.medicationDose || session.dose || session.Dose || session.MedicationDose || 'N/A' }}</p>
                              <p><strong>Route:</strong> {{ session.medicationRoute || session.route || session.Route || session.MedicationRoute || 'N/A' }}</p>
                              <p><strong>Administered At:</strong> {{ session.medicationAdministeredAt || session.administeredAt || session.AdministeredAt || session.MedicationAdministeredAt || 'N/A' }}</p>
                            </div>
                          }

                          <!-- Treatment Alerts -->
                          @if (session.alertType || session.AlertType || session.alertMessage || session.AlertMessage) {
                            <div class="detail-section alert-section">
                              <h4><mat-icon>warning</mat-icon> Treatment Alerts</h4>
                              <p><strong>Alert Type:</strong> {{ session.alertType || session.AlertType || 'N/A' }}</p>
                              <p><strong>Severity:</strong> 
                                <mat-chip [color]="(session.severity || session.Severity) === 'High' ? 'warn' : 'accent'" highlighted>
                                  {{ session.severity || session.Severity || 'N/A' }}
                                </mat-chip>
                              </p>
                              @if (session.alertMessage || session.AlertMessage) {
                                <p><strong>Alert Message:</strong> {{ session.alertMessage || session.AlertMessage }}</p>
                              }
                              @if (session.resolution || session.Resolution) {
                                <p><strong>Resolution:</strong> {{ session.resolution || session.Resolution }}</p>
                              }
                            </div>
                          }

                          <!-- Assigned Staff -->
                          <div class="detail-section">
                            <h4><mat-icon>people</mat-icon> Assigned Staff</h4>
                            <p><strong>Doctor:</strong> {{ session.assignedDoctorName || session.AssignedDoctorName || 'Not Assigned' }}</p>
                            <p><strong>Nurse:</strong> {{ session.assignedNurseName || session.AssignedNurseName || 'Not Assigned' }}</p>
                          </div>

                          <!-- Post-Dialysis Assessment -->
                          <div class="detail-section">
                            <h4><mat-icon>assignment_turned_in</mat-icon> Post-Dialysis Assessment</h4>
                            <p><strong>Post-Weight:</strong> {{ session.postWeight || session.PostWeight || 'N/A' }} {{ (session.postWeight || session.PostWeight) ? 'kg' : '' }}</p>
                            <p><strong>Weight Loss:</strong> {{ ((session.preWeight || session.PreWeight) && (session.postWeight || session.PostWeight)) ? (((session.preWeight || session.PreWeight) - (session.postWeight || session.PostWeight)) | number:'1.1-1') + ' kg' : 'N/A' }}</p>
                            <p><strong>Post-Systolic BP:</strong> {{ session.postSBP || session.PostSBP || 'N/A' }} {{ (session.postSBP || session.PostSBP) ? 'mmHg' : '' }}</p>
                            <p><strong>Post-Diastolic BP:</strong> {{ session.postDBP || session.PostDBP || 'N/A' }} {{ (session.postDBP || session.PostDBP) ? 'mmHg' : '' }}</p>
                            <p><strong>Post-Heart Rate:</strong> {{ session.postHR || session.PostHR || 'N/A' }} {{ (session.postHR || session.PostHR) ? 'bpm' : '' }}</p>
                          </div>

                          <!-- Additional Notes -->
                          @if (session.notes || session.Notes) {
                            <div class="detail-section full-width">
                              <h4><mat-icon>note</mat-icon> Session Notes</h4>
                              <p class="notes-text">{{ session.notes || session.Notes }}</p>
                            </div>
                          }
                        </div>
                        }

                        <div class="session-actions">
                          <button mat-raised-button color="primary" (click)="viewSessionDetails(session)">
                            <mat-icon>visibility</mat-icon>
                            View Full Details
                          </button>
                        </div>
                      </div>
                    </mat-expansion-panel>
                  }
                </div>
              } @else {
                <div class="empty-state">
                  <mat-icon>event_busy</mat-icon>
                  <p>No treatment sessions found</p>
                </div>
              }
            </div>
          </mat-tab>

          <!-- Vital Trends Tab -->
          <mat-tab label="Vital Trends">
            <div class="tab-content">
              @if (vitalTrends) {
                <div class="trends-container">
                  <!-- Weight Trends -->
                  @if (vitalTrends.weightTrend && vitalTrends.weightTrend.length > 0) {
                    <div class="trend-section">
                      <h4><mat-icon>monitor_weight</mat-icon> Weight Trends</h4>
                      <div class="trend-table">
                        <table mat-table [dataSource]="vitalTrends.weightTrend">
                          <ng-container matColumnDef="date">
                            <th mat-header-cell *matHeaderCellDef>Date</th>
                            <td mat-cell *matCellDef="let trend">{{ trend.sessionDate | date:'MMM d, y' }}</td>
                          </ng-container>
                          <ng-container matColumnDef="value">
                            <th mat-header-cell *matHeaderCellDef>Weight (kg)</th>
                            <td mat-cell *matCellDef="let trend">{{ trend.value | number:'1.1-1' }}</td>
                          </ng-container>
                          <ng-container matColumnDef="label">
                            <th mat-header-cell *matHeaderCellDef>Type</th>
                            <td mat-cell *matCellDef="let trend">{{ trend.label }}</td>
                          </ng-container>
                          <tr mat-header-row *matHeaderRowDef="['date', 'value', 'label']"></tr>
                          <tr mat-row *matRowDef="let row; columns: ['date', 'value', 'label'];"></tr>
                        </table>
                      </div>
                    </div>
                  }

                  <!-- Weight Loss Trends -->
                  @if (vitalTrends.weightLossTrend && vitalTrends.weightLossTrend.length > 0) {
                    <div class="trend-section">
                      <h4><mat-icon>trending_down</mat-icon> Weight Loss Per Session</h4>
                      <div class="trend-table">
                        <table mat-table [dataSource]="vitalTrends.weightLossTrend">
                          <ng-container matColumnDef="date">
                            <th mat-header-cell *matHeaderCellDef>Date</th>
                            <td mat-cell *matCellDef="let trend">{{ trend.sessionDate | date:'MMM d, y' }}</td>
                          </ng-container>
                          <ng-container matColumnDef="value">
                            <th mat-header-cell *matHeaderCellDef>Weight Loss (kg)</th>
                            <td mat-cell *matCellDef="let trend">{{ trend.value | number:'1.1-1' }}</td>
                          </ng-container>
                          <tr mat-header-row *matHeaderRowDef="['date', 'value']"></tr>
                          <tr mat-row *matRowDef="let row; columns: ['date', 'value'];"></tr>
                        </table>
                      </div>
                    </div>
                  }

                  <!-- Blood Pressure Trends -->
                  @if (vitalTrends.bloodPressureTrend && vitalTrends.bloodPressureTrend.length > 0) {
                    <div class="trend-section">
                      <h4><mat-icon>favorite</mat-icon> Blood Pressure Trends</h4>
                      <div class="trend-table">
                        <table mat-table [dataSource]="vitalTrends.bloodPressureTrend">
                          <ng-container matColumnDef="date">
                            <th mat-header-cell *matHeaderCellDef>Date</th>
                            <td mat-cell *matCellDef="let trend">{{ trend.sessionDate | date:'MMM d, y' }}</td>
                          </ng-container>
                          <ng-container matColumnDef="preBP">
                            <th mat-header-cell *matHeaderCellDef>Pre-BP</th>
                            <td mat-cell *matCellDef="let trend">{{ trend.preBP }}</td>
                          </ng-container>
                          <ng-container matColumnDef="postBP">
                            <th mat-header-cell *matHeaderCellDef>Post-BP</th>
                            <td mat-cell *matCellDef="let trend">{{ trend.postBP }}</td>
                          </ng-container>
                          <tr mat-header-row *matHeaderRowDef="['date', 'preBP', 'postBP']"></tr>
                          <tr mat-row *matRowDef="let row; columns: ['date', 'preBP', 'postBP'];"></tr>
                        </table>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-state">
                  <mat-icon>show_chart</mat-icon>
                  <p>No vital trends data available</p>
                  <p class="note">Vital trends will appear after completing more dialysis sessions</p>
                </div>
              }
            </div>
          </mat-tab>

          <!-- Medications Tab -->
          <mat-tab label="Medications">
            <div class="tab-content">
              @if (medications && medications.length > 0) {
                <div class="medications-list">
                  <h3><mat-icon>medication</mat-icon> Medication History</h3>
                  <p>Sessions with medications administered: {{ medications.length }}</p>
                  
                  @if (statistics && statistics.totalSessions > 0) {
                    <div class="medication-stats">
                      <p><strong>Common Medications:</strong></p>
                      <div class="medication-chips">
                        @for (med of statistics.commonMedications; track med) {
                          <mat-chip>{{ med }}</mat-chip>
                        }
                      </div>
                    </div>
                  }

                  <p class="note">Click on individual sessions in the Timeline tab to view detailed medication information for each session.</p>
                </div>
              } @else {
                <div class="empty-state">
                  <mat-icon>medication</mat-icon>
                  <p>No medications recorded</p>
                  <p class="note">Medications administered during dialysis will appear here</p>
                </div>
              }
            </div>
          </mat-tab>
        </mat-tab-group>
      }
    </mat-card-content>
  </mat-card>
</div>
