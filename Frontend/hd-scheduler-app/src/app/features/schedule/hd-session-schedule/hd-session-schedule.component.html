<div class="hd-session-schedule-container">
  <mat-card>
    <mat-card-content>
      @if (loading && !patient) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      }

      @if (errorMessage) {
        <div class="error-message">
          <mat-icon>error</mat-icon>
          {{ errorMessage }}
        </div>
      }

      <!-- Authentication Warning Banner -->
      @if (!isAuthenticated) {
        <div class="auth-warning-banner">
          <mat-icon class="warning-icon">lock</mat-icon>
          <div class="warning-content">
            <h3>üîê Authentication Required</h3>
            <p><strong>You must log in to save HD session data.</strong></p>
            <p>Any changes you make will NOT be saved until you authenticate.</p>
            <button mat-raised-button color="primary" (click)="goToLogin()">
              <mat-icon>login</mat-icon>
              Log In Now
            </button>
          </div>
        </div>
      }

      @if (patient) {
        <!-- Combined Patient Info Card with Auto-filled Fields -->
        <div class="patient-info-card-combined">
          <!-- Single Navigation Header -->
          <div class="card-navigation">
            <div class="nav-left">
              <button mat-icon-button (click)="goHome()" class="home-button" matTooltip="Home">
                <mat-icon>home</mat-icon>
              </button>
              <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Back">
                <mat-icon>arrow_back</mat-icon>
              </button>
              <h1 class="card-title">HD Session Schedule</h1>
            </div>
            
            <!-- Auto-save indicator -->
            <div class="auto-save-indicator" [class.saving]="saveStatus === 'saving'" [class.saved]="saveStatus === 'saved'" [class.visible]="saveStatus !== 'idle'">
              @if (saveStatus === 'saving') {
                <mat-spinner diameter="16"></mat-spinner>
                <span>Saving...</span>
              }
              @if (saveStatus === 'saved') {
                <mat-icon>check_circle</mat-icon>
                <span>Saved</span>
              }
            </div>
          </div>

          <!-- Patient Header Section -->
          <div class="patient-header">
            <div class="patient-name-section">
              <mat-icon class="person-icon">person</mat-icon>
              <div>
                <h2 class="patient-main-name">{{ patient.name || 'Unknown Patient' }}</h2>
                <p class="patient-subtitle">MRN: {{ patient.mrn || 'Not Assigned' }} | Age: {{ patient.age ? (patient.age + ' years') : 'N/A' }} | {{ patient.gender || 'N/A' }}</p>
              </div>
            </div>
          </div>
          
          <!-- Patient Details Table -->
          <div class="patient-details-table-container">
            <table class="patient-details-table">
              <tbody>
                <tr>
                  <td class="label-cell">Contact Number</td>
                  <td class="value-cell">{{ patient.contactNumber || 'N/A' }}</td>
                  <td class="label-cell">HD Cycle</td>
                  <td class="value-cell">{{ patient.hdCycle || 'N/A' }}</td>
                </tr>
                <tr>
                  <td class="label-cell">Dry Weight</td>
                  <td class="value-cell">{{ patient.dryWeight ? (patient.dryWeight + ' kg') : 'N/A' }}</td>
                  <td class="label-cell">Sessions Per Week</td>
                  <td class="value-cell">{{ patient.hdFrequency || 'N/A' }}</td>
                </tr>
                <tr>
                  <td class="label-cell">Dialyser Type</td>
                  <td class="value-cell">{{ patient.dialyserType || 'N/A' }}</td>
                  <td class="label-cell">Dialyser Model</td>
                  <td class="value-cell">{{ patient.dialyserModel || 'N/A' }}</td>
                </tr>
                <tr>
                  <td class="label-cell">Prescribed BFR</td>
                  <td class="value-cell">{{ patient.prescribedBFR ? (patient.prescribedBFR + ' mL/min') : 'N/A' }}</td>
                  <td class="label-cell">Prescribed Duration</td>
                  <td class="value-cell">{{ patient.prescribedDuration ? (patient.prescribedDuration + ' hours') : 'N/A' }}</td>
                </tr>
                <tr>
                  <td class="label-cell">Dialysate</td>
                  <td class="value-cell">{{ patient.dialysatePrescription || 'N/A' }}</td>
                  <td class="label-cell">HD Start Date</td>
                  <td class="value-cell">{{ patient.hdStartDate ? (patient.hdStartDate | date:'MMM d, y') : 'N/A' }}</td>
                </tr>
                <tr>
                  <td class="label-cell">Guardian</td>
                  <td class="value-cell">{{ patient.guardianName || 'N/A' }}</td>
                  <td class="label-cell">Emergency Contact</td>
                  <td class="value-cell">{{ patient.emergencyContact || 'N/A' }}</td>
                </tr>
              </tbody>
            </table>
          </div>


        </div>

        <!-- Patient History Expansion Panel -->
        @if (showPatientHistory) {
          <mat-expansion-panel expanded class="history-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>history</mat-icon>
                <strong>Treatment History ({{ patientHistory.length }} sessions)</strong>
              </mat-panel-title>
            </mat-expansion-panel-header>
            
            @if (patientHistory.length === 0) {
              <div class="no-history">
                <mat-icon>info</mat-icon>
                <p>No previous treatment sessions found</p>
              </div>
            } @else {
              <div class="history-table-container">
                <table mat-table [dataSource]="patientHistory" class="history-table">
                  
                  <!-- Date Column -->
                  <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef>Date</th>
                    <td mat-cell *matCellDef="let session">{{ session.sessionDate | date:'MMM dd, yyyy' }}</td>
                  </ng-container>

                  <!-- Slot Column -->
                  <ng-container matColumnDef="slot">
                    <th mat-header-cell *matHeaderCellDef>Time Slot</th>
                    <td mat-cell *matCellDef="let session">Slot {{ session.slotID }} - Bed {{ session.bedNumber }}</td>
                  </ng-container>

                  <!-- Duration Column -->
                  <ng-container matColumnDef="duration">
                    <th mat-header-cell *matHeaderCellDef>Duration</th>
                    <td mat-cell *matCellDef="let session">{{ session.prescribedDuration || 'N/A' }} hrs</td>
                  </ng-container>

                  <!-- Dialyser Column -->
                  <ng-container matColumnDef="dialyser">
                    <th mat-header-cell *matHeaderCellDef>Dialyser</th>
                    <td mat-cell *matCellDef="let session">
                      {{ (session.dialyserType || session.DialyserType || 'N/A') }} - {{ (session.dialyserModel || session.DialyserModel || 'N/A') }}
                    </td>
                  </ng-container>

                  <!-- Dry Weight Column -->
                  <ng-container matColumnDef="dryWeight">
                    <th mat-header-cell *matHeaderCellDef>Dry Weight</th>
                    <td mat-cell *matCellDef="let session">
                      {{ session.dryWeight || session.DryWeight || 'N/A' }}{{ (session.dryWeight || session.DryWeight) ? ' kg' : '' }}
                    </td>
                  </ng-container>

                  <!-- Pre Weight Column -->
                  <ng-container matColumnDef="preWeight">
                    <th mat-header-cell *matHeaderCellDef>Pre Weight</th>
                    <td mat-cell *matCellDef="let session">
                      {{ session.preWeight || session.PreWeight || 'N/A' }}{{ (session.preWeight || session.PreWeight) ? ' kg' : '' }}
                    </td>
                  </ng-container>

                  <!-- Post Weight Column -->
                  <ng-container matColumnDef="postWeight">
                    <th mat-header-cell *matHeaderCellDef>Post Weight</th>
                    <td mat-cell *matCellDef="let session">
                      {{ session.postWeight || session.PostWeight || 'N/A' }}{{ (session.postWeight || session.PostWeight) ? ' kg' : '' }}
                    </td>
                  </ng-container>

                  <!-- UF Goal Column -->
                  <ng-container matColumnDef="ufGoal">
                    <th mat-header-cell *matHeaderCellDef>UF Goal</th>
                    <td mat-cell *matCellDef="let session">
                      {{ session.ufGoal || session.UFGoal || 'N/A' }}{{ (session.ufGoal || session.UFGoal) ? ' L' : '' }}
                    </td>
                  </ng-container>

                  <!-- Access Type/Location Column -->
                  <ng-container matColumnDef="access">
                    <th mat-header-cell *matHeaderCellDef>Access</th>
                    <td mat-cell *matCellDef="let session">
                      {{ session.accessType || session.AccessType || 'N/A' }}
                      @if (session.accessLocation || session.AccessLocation) {
                        <br><small>{{ session.accessLocation || session.AccessLocation }}</small>
                      }
                    </td>
                  </ng-container>

                  <!-- BFR Column -->
                  <ng-container matColumnDef="bfr">
                    <th mat-header-cell *matHeaderCellDef>BFR</th>
                    <td mat-cell *matCellDef="let session">
                      {{ session.prescribedBFR || session.PrescribedBFR || session.actualBFR || session.ActualBFR || 'N/A' }}
                      @if (session.prescribedBFR || session.PrescribedBFR || session.actualBFR || session.ActualBFR) {
                        <span> mL/min</span>
                      }
                    </td>
                  </ng-container>

                  <!-- Heart Rate Column -->
                  <ng-container matColumnDef="heartRate">
                    <th mat-header-cell *matHeaderCellDef>Heart Rate</th>
                    <td mat-cell *matCellDef="let session">
                      {{ session.heartRate || session.HeartRate || 'N/A' }}
                      @if (session.heartRate || session.HeartRate) {
                        <span> bpm</span>
                      }
                    </td>
                  </ng-container>

                  <!-- BP Column -->
                  <ng-container matColumnDef="bp">
                    <th mat-header-cell *matHeaderCellDef>BP (Pre/Post)</th>
                    <td mat-cell *matCellDef="let session">
                      {{ session.preBPSitting || session.PreBPSitting || session.bloodPressurePre || session.BloodPressurePre || 'N/A' }}
                      /
                      {{ session.bloodPressurePost || session.BloodPressurePost || 'N/A' }}
                    </td>
                  </ng-container>

                  <!-- Medications Column -->
                  <ng-container matColumnDef="medications">
                    <th mat-header-cell *matHeaderCellDef>Medications</th>
                    <td mat-cell *matCellDef="let session">
                      @if (session.medicationName || session.MedicationName) {
                        {{ session.medicationName || session.MedicationName }}
                        @if (session.dose || session.Dose) {
                          <br><small>{{ session.dose || session.Dose }} {{ session.route || session.Route }}</small>
                        }
                      } @else {
                        <span>N/A</span>
                      }
                    </td>
                  </ng-container>

                  <!-- Alerts Column -->
                  <ng-container matColumnDef="alerts">
                    <th mat-header-cell *matHeaderCellDef>Alerts</th>
                    <td mat-cell *matCellDef="let session">
                      @if (session.alertType || session.AlertType) {
                        <mat-icon [class.warn]="(session.severity || session.Severity) === 'High'" matTooltip="{{ session.alertMessage || session.AlertMessage || '' }}">
                          warning
                        </mat-icon>
                        <small>{{ session.alertType || session.AlertType }}</small>
                      } @else {
                        <span>None</span>
                      }
                    </td>
                  </ng-container>

                  <!-- Status Column -->
                  <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let session">
                      <span class="status-badge" [class.completed]="session.isDischarged" [class.ongoing]="!session.isDischarged">
                        {{ session.isDischarged ? 'Completed' : 'Ongoing' }}
                      </span>
                    </td>
                  </ng-container>

                  <!-- Actions Column -->
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let session">
                      <button mat-icon-button color="primary" matTooltip="View Full Details" 
                              (click)="viewSessionDetails(session.scheduleID)">
                        <mat-icon>visibility</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="['date', 'slot', 'duration', 'dialyser', 'dryWeight', 'preWeight', 'postWeight', 'ufGoal', 'access', 'bfr', 'heartRate', 'bp', 'medications', 'alerts', 'status', 'actions']"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['date', 'slot', 'duration', 'dialyser', 'dryWeight', 'preWeight', 'postWeight', 'ufGoal', 'access', 'bfr', 'heartRate', 'bp', 'medications', 'alerts', 'status', 'actions'];"></tr>
                </table>
              </div>
            }
          </mat-expansion-panel>
        }

        <form [formGroup]="sessionForm">
          <mat-stepper #stepper>
            
            <!-- Step 1: HD Prescription & Treatment Plan -->
            <mat-step label="Prescription & Treatment Plan">
              <h3 class="step-title">
                <mat-icon>medical_services</mat-icon>
                HD Prescription & Treatment Details
              </h3>
              
              <!-- Date, Slot & Bed Selection -->
              <div class="section-card">
                <h4>Select Date, Time Slot & Bed</h4>
                
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Treatment Date*</mat-label>
                    <input matInput [matDatepicker]="picker" formControlName="treatmentDate" [max]="today" required>
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                    <mat-error *ngIf="sessionForm.get('treatmentDate')?.hasError('matDatepickerMax')">
                      Cannot select future dates
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Time Slot*</mat-label>
                    <mat-select formControlName="slotID" (selectionChange)="onSlotChange()" required>
                      @for (slot of slots; track slot.id) {
                        <mat-option [value]="slot.id">
                          {{ slot.name }} ({{ slot.time }})
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>

                @if (selectedSlot) {
                  <!-- Bed Assignment Mode Toggle -->
                  <div class="bed-mode-selection">
                    <h4><mat-icon>bed</mat-icon> Bed Assignment</h4>
                    <mat-radio-group [(ngModel)]="bedAssignmentMode" [ngModelOptions]="{standalone: true}" (change)="onBedModeChange()" class="bed-mode-radio">
                      <mat-radio-button value="auto" color="primary">
                        <mat-icon>auto_mode</mat-icon> Auto-assign next available bed
                      </mat-radio-button>
                      <mat-radio-button value="manual" color="primary">
                        <mat-icon>touch_app</mat-icon> Let me choose manually
                      </mat-radio-button>
                    </mat-radio-group>
                  </div>

                  <!-- Auto-assigned Bed Display -->
                  @if (bedAssignmentMode === 'auto' && autoAssignedBed) {
                    <div class="auto-assigned-bed">
                      <mat-icon class="check-icon">check_circle</mat-icon>
                      <div class="assigned-info">
                        <strong>Bed {{ autoAssignedBed }}</strong> has been assigned
                        <span class="hint">Selected with smart spacing for infection control</span>
                      </div>
                      <button mat-stroked-button color="accent" (click)="changeBedManually()" class="change-bed-btn">
                        <mat-icon>swap_horiz</mat-icon> Change Bed
                      </button>
                    </div>
                  }

                  <!-- Manual Bed Selection Grid -->
                  @if (bedAssignmentMode === 'manual') {
                    <div class="bed-selection-section">
                      <h4>Available Beds - Click to Select</h4>
                      <div class="beds-grid">
                        @for (bed of beds; track bed.number) {
                          <div class="bed-item" 
                               [class.occupied]="bed.isOccupied"
                               [class.selected]="selectedBed === bed.number"
                               (click)="selectBed(bed.number, bed.isOccupied)"
                               [matTooltip]="bed.isOccupied ? 'Occupied by ' + bed.patientName : 'Available'">
                            <mat-icon>{{ bed.isOccupied ? 'hotel' : 'bed' }}</mat-icon>
                            <span>Bed {{ bed.number }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                }
              </div>

              <!-- Vascular Access -->
              <div class="section-card">
                <h4>Vascular Access</h4>
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Access Type*</mat-label>
                    <mat-select formControlName="accessType" required>
                      @for (type of accessTypes; track type) {
                        <mat-option [value]="type">{{ type }}</mat-option>
                      }
                    </mat-select>
                    <mat-hint>AVF/AVG/CVC</mat-hint>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Access Location</mat-label>
                    <input matInput formControlName="accessLocation" placeholder="e.g., Left radiocephalic">
                  </mat-form-field>
                </div>
              </div>

              <!-- Anticoagulation -->
              <div class="section-card">
                <h4>Anticoagulation</h4>
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Anticoagulation Type</mat-label>
                    <mat-select formControlName="anticoagulationType">
                      @for (type of anticoagulationTypes; track type) {
                        <mat-option [value]="type">{{ type }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Heparin Bolus Dose (mL)</mat-label>
                    <input matInput type="number" formControlName="heparinBolusDose" step="0.01">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Heparin Infusion Rate (mL/hr)</mat-label>
                    <input matInput type="number" formControlName="heparinInfusionRate" step="0.01">
                  </mat-form-field>
                </div>
              </div>

              <div class="step-actions">
                <button mat-button (click)="goBack()" type="button">Cancel</button>
                <div class="right-actions">
                  <button mat-stroked-button color="primary" (click)="saveDraftAndExit()" type="button" [disabled]="sessionForm.invalid">
                    <mat-icon>save</mat-icon>
                    Save Draft & Exit
                  </button>
                  <button mat-raised-button color="primary" matStepperNext type="button">
                    Next <mat-icon>arrow_forward</mat-icon>
                  </button>
                  <button mat-raised-button color="accent" (click)="saveCurrentStep()" type="button" [disabled]="loading">
                    <mat-icon>save</mat-icon>
                    Save Progress
                  </button>
                </div>
              </div>
            </mat-step>

            <!-- Step 2: Treatment Session Details -->
            <mat-step label="Session Details">
              <h3 class="step-title">
                <mat-icon>assignment</mat-icon>
                Treatment Session Details
              </h3>

              <div class="section-card">
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Start Time</mat-label>
                    <input matInput type="time" formControlName="startTime">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Pre-Weight (kg)*</mat-label>
                    <input matInput type="number" formControlName="preWeight" step="0.01" required>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>UF Goal (L)</mat-label>
                    <input matInput type="number" formControlName="ufGoal" step="0.01">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Pre-BP Sitting</mat-label>
                    <input matInput formControlName="preBPSitting" placeholder="140/90">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Pre-Temperature (¬∞C)</mat-label>
                    <input matInput type="number" formControlName="preTemperature" step="0.1">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Access Bleeding Time (min)</mat-label>
                    <input matInput type="number" formControlName="accessBleedingTime">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Access Status</mat-label>
                    <input matInput formControlName="accessStatus">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Complications</mat-label>
                    <textarea matInput formControlName="complications" rows="3"></textarea>
                  </mat-form-field>
                </div>
              </div>

              <div class="step-actions">
                <button mat-button matStepperPrevious type="button">
                  <mat-icon>arrow_back</mat-icon> Previous
                </button>
                <button mat-raised-button color="primary" matStepperNext type="button">
                  Next <mat-icon>arrow_forward</mat-icon>
                </button>
                <button mat-raised-button color="accent" (click)="saveCurrentStep()" type="button" [disabled]="loading">
                  <mat-icon>save</mat-icon>
                  Save Progress
                </button>
              </div>
            </mat-step>

            <!-- Step 3: Intra-Dialytic Monitoring -->
            <mat-step label="Monitoring">
              <h3 class="step-title">
                <mat-icon>monitor_heart</mat-icon>
                Intra-Dialytic Monitoring
                <span class="monitoring-info">Record vitals every 30-60 minutes</span>
              </h3>

              <!-- Monitoring Records List -->
              @if (monitoringRecords && monitoringRecords.length > 0) {
                <div class="monitoring-records-list">
                  <h4>
                    <mat-icon>list</mat-icon>
                    Recorded Monitoring Entries ({{ monitoringRecords.length }})
                  </h4>
                  <div class="records-grid">
                    @for (record of monitoringRecords; track record.recordID || $index) {
                      <div class="monitoring-record-card">
                        <div class="record-header">
                          <mat-icon class="record-icon">schedule</mat-icon>
                          <div class="record-title">
                            <h5>Reading #{{ $index + 1 }}</h5>
                            <span class="record-time">{{ record.timeRecorded | date:'short' }}</span>
                          </div>
                        </div>
                        <div class="record-details">
                          <div class="vital-row">
                            <span class="vital-label">BP:</span>
                            <span class="vital-value">{{ (record.bloodPressure || record.BloodPressure) || 'N/A' }}</span>
                          </div>
                          <div class="vital-row">
                            <span class="vital-label">HR:</span>
                            <span class="vital-value">{{ (record.pulseRate || record.PulseRate) || 'N/A' }} bpm</span>
                          </div>
                          <div class="vital-row">
                            <span class="vital-label">Temp:</span>
                            <span class="vital-value">{{ (record.temperature || record.Temperature) || 'N/A' }}¬∞C</span>
                          </div>
                          <div class="vital-row">
                            <span class="vital-label">UF Volume:</span>
                            <span class="vital-value">{{ (record.ufVolume || record.UFVolume) || 'N/A' }} L</span>
                          </div>
                          <div class="vital-row">
                            <span class="vital-label">VP:</span>
                            <span class="vital-value">{{ (record.venousPressure || record.VenousPressure) || 'N/A' }} mmHg</span>
                          </div>
                          @if (record.arterialPressure || record.ArterialPressure) {
                            <div class="vital-row">
                              <span class="vital-label">AP:</span>
                              <span class="vital-value">{{ record.arterialPressure || record.ArterialPressure }} mmHg</span>
                            </div>
                          }
                          @if (record.bloodFlowRate || record.BloodFlowRate) {
                            <div class="vital-row">
                              <span class="vital-label">BFR:</span>
                              <span class="vital-value">{{ record.bloodFlowRate || record.BloodFlowRate }} mL/min</span>
                            </div>
                          }
                          @if (record.currentUFR || record.CurrentUFR) {
                            <div class="vital-row">
                              <span class="vital-label">UFR:</span>
                              <span class="vital-value">{{ record.currentUFR || record.CurrentUFR }} mL/hr</span>
                            </div>
                          }
                          @if (record.tmpPressure || record.TMPPressure) {
                            <div class="vital-row">
                              <span class="vital-label">TMP:</span>
                              <span class="vital-value">{{ record.tmpPressure || record.TMPPressure }} mmHg</span>
                            </div>
                          }
                          @if (record.symptoms || record.Symptoms) {
                            <div class="vital-row full-width">
                              <span class="vital-label">Symptoms:</span>
                              <span class="vital-value">{{ record.symptoms || record.Symptoms }}</span>
                            </div>
                          }
                          @if (record.interventions || record.Interventions) {
                            <div class="vital-row full-width">
                              <span class="vital-label">Interventions:</span>
                              <span class="vital-value">{{ record.interventions || record.Interventions }}</span>
                            </div>
                          }
                          @if (record.staffInitials || record.StaffInitials) {
                            <div class="vital-row">
                              <span class="vital-label">Staff:</span>
                              <span class="vital-value">{{ record.staffInitials || record.StaffInitials }}</span>
                            </div>
                          }
                          @if (record.notes || record.Notes) {
                            <div class="vital-row full-width">
                              <span class="vital-label">Notes:</span>
                              <span class="vital-value">{{ record.notes || record.Notes }}</span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Session Must Be Saved First Warning -->
              @if (!scheduleId) {
                <div class="warning-banner" style="margin-bottom: 20px; padding: 16px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <mat-icon style="color: #ff9800;">warning</mat-icon>
                    <div>
                      <strong>Session Not Saved Yet</strong>
                      <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">
                        Please scroll up and click the <strong>"Save HD Session"</strong> button before adding monitoring records.
                      </p>
                    </div>
                  </div>
                </div>
              }
              
              <!-- New Monitoring Entry Form -->
              <div class="section-card monitoring-entry-card" [class.disabled-section]="!scheduleId">
                <div class="card-header">
                  <mat-icon>add_circle</mat-icon>
                  <h4>New Monitoring Entry #{{ (monitoringRecords?.length || 0) + 1 }}</h4>
                  <span class="entry-time">{{ currentTime | date:'shortTime' }}</span>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Blood Pressure</mat-label>
                    <input matInput formControlName="bloodPressure" placeholder="140/90">
                    <mat-hint>Systolic/Diastolic</mat-hint>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Heart Rate (bpm)</mat-label>
                    <input matInput type="number" formControlName="heartRate" placeholder="75">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Temperature (¬∞C)</mat-label>
                    <input matInput type="number" formControlName="temperature" step="0.1" placeholder="36.5">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Actual BFR (mL/min)</mat-label>
                    <input matInput type="number" formControlName="actualBFR" placeholder="350">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Venous Pressure (mmHg)</mat-label>
                    <input matInput type="number" formControlName="venousPressure" placeholder="150">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Arterial Pressure (mmHg)</mat-label>
                    <input matInput type="number" formControlName="arterialPressure" placeholder="-200">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Current UFR (mL/hr)</mat-label>
                    <input matInput type="number" formControlName="currentUFR" placeholder="500">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Total UF Achieved (L)</mat-label>
                    <input matInput type="number" formControlName="totalUFAchieved" step="0.01" placeholder="2.5">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>TMP (mmHg)</mat-label>
                    <input matInput type="number" formControlName="tmpPressure" placeholder="100">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Symptoms</mat-label>
                    <textarea matInput formControlName="symptoms" rows="2" placeholder="Any patient complaints or symptoms observed"></textarea>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Interventions</mat-label>
                    <textarea matInput formControlName="interventions" rows="2" placeholder="Actions taken in response to symptoms"></textarea>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Staff Initials</mat-label>
                    <input matInput formControlName="staffInitials" maxlength="10" placeholder="e.g., JD">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Additional Notes</mat-label>
                    <input matInput formControlName="monitoringNotes" placeholder="Any additional observations">
                  </mat-form-field>
                </div>

                <div class="monitoring-actions">
                  <button mat-raised-button color="accent" (click)="addMonitoringRecord()" type="button" [disabled]="loading || !scheduleId">
                    <mat-icon>add_circle</mat-icon>
                    Save Monitoring Entry #{{ (monitoringRecords?.length || 0) + 1 }}
                  </button>
                  <span class="hint-text">Save this reading and add another if needed</span>
                </div>
              </div>

              <div class="step-actions">
                <button mat-button matStepperPrevious type="button">
                  <mat-icon>arrow_back</mat-icon> Previous
                </button>
                <button mat-button matStepperNext type="button" [disabled]="!monitoringRecords || monitoringRecords.length === 0">
                  Next <mat-icon>arrow_forward</mat-icon>
                </button>
                <span class="step-hint">At least one monitoring entry required to proceed</span>
              </div>
            </mat-step>

            <!-- Step 4: Post-Dialysis Assessment & Medications -->
            <mat-step label="Post-Dialysis">
              <h3 class="step-title">
                <mat-icon>assignment_turned_in</mat-icon>
                Post-Dialysis Assessment & Medications
              </h3>

              <div class="section-card">
                <h4 class="section-subtitle">Post-Dialysis Vital Signs & Measurements</h4>
                
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Post-Dialysis Weight (kg)</mat-label>
                    <input matInput type="number" formControlName="postWeight" step="0.1" placeholder="e.g., 68.0">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Post-Dialysis Systolic BP (mmHg)</mat-label>
                    <input matInput type="number" formControlName="postSBP" placeholder="e.g., 130">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Post-Dialysis Diastolic BP (mmHg)</mat-label>
                    <input matInput type="number" formControlName="postDBP" placeholder="e.g., 78">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Post-Dialysis HR (bpm)</mat-label>
                    <input matInput type="number" formControlName="postHR" placeholder="e.g., 80">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Total Fluid Removed (L)</mat-label>
                    <input matInput type="number" formControlName="totalFluidRemoved" step="0.1" placeholder="e.g., 3.5">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Post-Access Status</mat-label>
                    <input matInput formControlName="postAccessStatus" placeholder="e.g., Site clean, no bleeding">
                  </mat-form-field>
                </div>

                <h4 class="section-subtitle">Post-Dialysis Medications</h4>
                
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Medication Type</mat-label>
                    <mat-select formControlName="medicationType">
                      <mat-option value="EPO">EPO</mat-option>
                      <mat-option value="Iron">Iron</mat-option>
                      <mat-option value="Antibiotic">Antibiotic</mat-option>
                      <mat-option value="Vitamin">Vitamin</mat-option>
                      <mat-option value="Other">Other</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Medication Name</mat-label>
                    <input matInput formControlName="medicationName">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Dose</mat-label>
                    <input matInput formControlName="dose" placeholder="e.g., 4000 IU">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Route</mat-label>
                    <mat-select formControlName="route">
                      <mat-option value="IV">IV</mat-option>
                      <mat-option value="Oral">Oral</mat-option>
                      <mat-option value="Subcutaneous">Subcutaneous</mat-option>
                      <mat-option value="Intramuscular">Intramuscular</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Administered At</mat-label>
                    <input matInput type="time" formControlName="administeredAt">
                  </mat-form-field>
                </div>
              </div>

              <div class="step-actions">
                <button mat-button matStepperPrevious type="button">
                  <mat-icon>arrow_back</mat-icon> Previous
                </button>
                <button mat-button matStepperNext type="button">
                  Next <mat-icon>arrow_forward</mat-icon>
                </button>
                <button mat-raised-button color="primary" (click)="saveCurrentStep()" type="button" [disabled]="loading">
                  <mat-icon>save</mat-icon>
                  Save Progress
                </button>
              </div>
            </mat-step>

            <!-- Step 5: Treatment Alerts & Submit -->
            <mat-step label="Alerts & Submit">
              <h3 class="step-title">
                <mat-icon>warning</mat-icon>
                Treatment Alerts & Final Review
              </h3>

              <div class="section-card">
                <h4 class="section-subtitle">Treatment Alerts (Optional)</h4>
                
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Alert Type</mat-label>
                    <mat-select formControlName="alertType">
                      <mat-option value="Hypotension">Hypotension</mat-option>
                      <mat-option value="Hypertension">Hypertension</mat-option>
                      <mat-option value="Cramping">Cramping</mat-option>
                      <mat-option value="Nausea">Nausea</mat-option>
                      <mat-option value="Chest Pain">Chest Pain</mat-option>
                      <mat-option value="Access Issue">Access Issue</mat-option>
                      <mat-option value="Equipment Malfunction">Equipment Malfunction</mat-option>
                      <mat-option value="Other">Other</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Severity</mat-label>
                    <mat-select formControlName="severity">
                      <mat-option value="Low">Low</mat-option>
                      <mat-option value="Medium">Medium</mat-option>
                      <mat-option value="High">High</mat-option>
                      <mat-option value="Critical">Critical</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Alert Message</mat-label>
                    <textarea matInput formControlName="alertMessage" rows="3" placeholder="Describe the alert or incident"></textarea>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Resolution</mat-label>
                    <textarea matInput formControlName="resolution" rows="3" placeholder="Describe actions taken or resolution"></textarea>
                  </mat-form-field>
                </div>

                <h4 class="section-subtitle">Additional Notes</h4>
                
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Session Notes</mat-label>
                    <textarea matInput formControlName="notes" rows="4" placeholder="Any additional notes or observations about the session"></textarea>
                  </mat-form-field>
                </div>
              </div>

              <div class="step-actions">
                <button mat-button matStepperPrevious type="button">
                  <mat-icon>arrow_back</mat-icon> Previous
                </button>
                <button mat-raised-button color="accent" (click)="saveCurrentStep()" type="button" [disabled]="loading">
                  @if (loading) {
                    <mat-spinner diameter="20"></mat-spinner>
                  } @else {
                    <mat-icon>save</mat-icon>
                    Save Progress
                  }
                </button>
                <button mat-raised-button color="primary" (click)="onSubmit()" type="button" [disabled]="loading || sessionForm.invalid">
                  @if (loading) {
                    <mat-spinner diameter="20"></mat-spinner>
                  } @else {
                    <mat-icon>check_circle</mat-icon>
                    Complete & Submit
                  }
                </button>
              </div>
            </mat-step>


          </mat-stepper>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>
