<div class="schedule-container">
  <div class="e-card">
    <div class="e-card-header">
      <div class="e-card-header-title">
        <div class="header-row">
          <div class="header-left">
            <button class="e-btn e-icon-btn" (click)="goBack()">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Daily HD Schedule</h2>
          </div>
          <div class="header-actions">
            <ejs-datepicker
              placeholder="Select Date"
              [(value)]="selectedDate"
              (change)="onDateChange()"
              [cssClass]="'date-picker'">
            </ejs-datepicker>
            <button class="e-btn e-icon-btn" (click)="onRefresh()" ejs-tooltip content="Refresh Now">
              <mat-icon>refresh</mat-icon>
            </button>
            <ejs-switch
              [(checked)]="autoRefreshEnabled"
              (change)="toggleAutoRefresh()"
              [cssClass]="'auto-refresh-toggle'"
              ejs-tooltip content="Auto-refresh every 30 seconds">
            </ejs-switch>
            <span class="switch-label">Auto-Refresh</span>
          </div>
        </div>
      </div>
    </div>

    <div class="e-card-content">
      <!-- Tabs for Today's Schedule and Future Bed Schedule -->
      <ejs-tab [selectedItem]="selectedTab" (selected)="onTabChange($event.selectedIndex)">
        <e-tabitems>
          <!-- Tab 1: Today's Daily Schedule -->
          <e-tabitem [header]="{'text': 'Today\'s Schedule'}">
            <ng-template #content>
              <!-- Statistics -->
              @if (schedule && !loading) {
                <div class="stats-row">
                  <div class="stat-card occupied-stat">
                    <div class="stat-icon">
                      <mat-icon>person</mat-icon>
                    </div>
                    <div class="stat-content">
                      <div class="stat-value">{{ getTotalOccupied() }}</div>
                      <div class="stat-label">Occupied Beds</div>
                    </div>
                  </div>
                  <div class="stat-card pre-scheduled-stat">
                    <div class="stat-icon">
                      <mat-icon>event</mat-icon>
                    </div>
                    <div class="stat-content">
                      <div class="stat-value">{{ getTotalPreScheduled() }}</div>
                      <div class="stat-label">Pre-Scheduled</div>
                    </div>
                  </div>
                  <div class="stat-card available-stat">
                    <div class="stat-icon">
                      <mat-icon>check_circle</mat-icon>
                    </div>
                    <div class="stat-content">
                      <div class="stat-value">{{ getTotalCapacity() - getTotalOccupied() }}</div>
                      <div class="stat-label">Available Beds</div>
                    </div>
                  </div>
                  <div class="stat-card occupancy-stat">
                    <div class="stat-icon">
                      <mat-icon>pie_chart</mat-icon>
                    </div>
                    <div class="stat-content">
                      <div class="stat-value">{{ getOccupancyRate() }}%</div>
                      <div class="stat-label">Occupancy Rate</div>
                    </div>
                  </div>
                </div>
              }

              <!-- Loading Spinner -->
              @if (loading) {
                <div class="loading-container">
                  <div class="e-spinner-pane">
                    <div class="e-spinner-inner">
                      <div class="e-spin-material"></div>
                    </div>
                  </div>
                </div>
              }

              <!-- Error Message -->
              @if (errorMessage && !loading) {
                <div class="error-message">
                  <mat-icon>error</mat-icon>
                  {{ errorMessage }}
                </div>
              }

              <!-- Schedule Grid -->
              @if (!loading && !errorMessage && schedule) {
                <!-- Search and Filter Controls -->
                <div class="filter-controls">
                  <div class="search-box">
                    <mat-icon>search</mat-icon>
                    <input type="text" 
                           placeholder="Search by patient name..." 
                           [(ngModel)]="searchText"
                           class="search-input">
                  </div>
                  
                  <div class="hd-cycle-filter">
                    <mat-icon>repeat</mat-icon>
                    <select [(ngModel)]="filterHDCycle" class="filter-select">
                      <option value="">All HD Cycles</option>
                      @for (cycle of getUniqueHDCycles(); track cycle) {
                        <option [value]="cycle">{{ cycle }}</option>
                      }
                    </select>
                  </div>

                  <div class="status-filters">
                    <button class="filter-btn bed-release-btn" 
                            [class.active]="showOccupied"
                            (click)="showOccupied = !showOccupied"
                            title="Show beds requiring release">
                      <mat-icon>logout</mat-icon>
                      <span>Bed Release</span>
                      <span class="count-badge">{{ getTotalBedRelease() }}</span>
                    </button>
                    
                    <button class="filter-btn available-btn" 
                            [class.active]="showAvailable"
                            (click)="showAvailable = !showAvailable"
                            title="Show available beds">
                      <mat-icon>check_circle</mat-icon>
                      <span>Available</span>
                      <span class="count-badge">{{ getTotalAvailable() }}</span>
                    </button>
                    
                    <button class="filter-btn pre-scheduled-btn" 
                            [class.active]="showReserved"
                            (click)="showReserved = !showReserved"
                            title="Show pre-scheduled patients">
                      <mat-icon>event</mat-icon>
                      <span>Pre-Schedule</span>
                      <span class="count-badge">{{ getTotalPreScheduled() }}</span>
                    </button>
                    
                    <button class="filter-btn completed-btn" 
                            [class.active]="showCompleted"
                            (click)="showCompleted = !showCompleted"
                            title="Show completed sessions">
                      <mat-icon>verified</mat-icon>
                      <span>Completed</span>
                      <span class="count-badge">{{ getTotalCompleted() }}</span>
                    </button>
                    
                    <button class="filter-btn discharged-btn" 
                            [class.active]="showDischarged"
                            (click)="showDischarged = !showDischarged"
                            title="Show discharged patients">
                      <mat-icon>exit_to_app</mat-icon>
                      <span>Discharged</span>
                      <span class="count-badge">{{ getTotalDischarged() }}</span>
                    </button>
                  </div>

                  <div class="current-time-display">
                    <mat-icon>access_time</mat-icon>
                    <span>{{ currentTime | date:'short' }}</span>
                  </div>
                </div>

                <div class="grid-navigation-wrapper">
                  <button class="e-btn e-fab nav-button nav-button-left" (click)="goToPreviousDay()" ejs-tooltip content="Previous Day">
                    <mat-icon>chevron_left</mat-icon>
                  </button>
                  
                  <div class="schedule-grid">
                    <!-- Compact Legend with Filters -->
                    <div class="legend-bar">
                      <div class="legend-section">
                        <span class="legend-title">
                          <mat-icon>palette</mat-icon>
                          Bed Status:
                        </span>
                        <div class="legend-items">
                          <div class="legend-chip available">
                            <mat-icon>check_circle</mat-icon>
                            <span>Available</span>
                          </div>
                          <div class="legend-chip occupied">
                            <mat-icon>person</mat-icon>
                            <span>Occupied</span>
                          </div>
                          <div class="legend-chip pre-scheduled">
                            <mat-icon>event</mat-icon>
                            <span>Pre-Scheduled (Ready to Activate)</span>
                          </div>
                          <div class="legend-chip completed">
                            <mat-icon>verified</mat-icon>
                            <span>Completed</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Schedule Cards -->
                    <div class="slots-container">
                      @for (slot of schedule.slots; track slot.slotID) {
                        <div class="slot-card">
                          <!-- Slot Header -->
                          <div class="slot-card-header">
                            <div class="slot-info">
                              <h3>{{ slot.slotName }}</h3>
                              <span class="time-range">
                                <mat-icon>schedule</mat-icon>
                                {{ slot.timeRange }}
                              </span>
                            </div>
                            <div class="slot-stats">
                              <span class="capacity-badge">
                                <mat-icon>meeting_room</mat-icon>
                                <span class="capacity-text">{{ getSlotAvailable(slot) }} of {{ slot.maxBeds || 10 }} Available</span>
                              </span>
                              <span class="stat-badge occupied">
                                <mat-icon>person</mat-icon>
                                {{ getSlotOccupied(slot) }}
                              </span>
                            </div>
                          </div>

                          <!-- Beds Grid -->
                          <div class="beds-grid">
                            @for (bed of getBedsForSlot(slot); track bed) {
                              <div class="bed-card" 
                                   [class]="getBedClass(slot.slotID, bed)"
                                   [class.clickable]="getBed(slot.slotID, bed)?.status === 'occupied' || getBed(slot.slotID, bed)?.status === 'pre-scheduled' || getBed(slot.slotID, bed)?.status === 'completed'"
                                   [title]="getBedTooltip(slot.slotID, bed)"
                                   (click)="onBedClick(slot.slotID, bed)">
                                
                                <div class="bed-number">
                                  <mat-icon>hotel</mat-icon>
                                  <span>{{ bed }}</span>
                                </div>

                                @if (getBed(slot.slotID, bed)?.patient) {
                                  <div class="patient-card-info">
                                    <div class="patient-name">{{ getBed(slot.slotID, bed)?.patient?.name }}</div>
                                    <div class="patient-details">
                                      <span class="age">
                                        <mat-icon>cake</mat-icon>
                                        {{ getBed(slot.slotID, bed)?.patient?.age }} yrs
                                      </span>
                                    </div>
                                    
                                    <!-- HD Cycle Badge -->
                                    @if (getBed(slot.slotID, bed)?.patient?.hdCycle) {
                                      <div class="hd-cycle-badge">
                                        <mat-icon>repeat</mat-icon>
                                        <span>{{ getBed(slot.slotID, bed)?.patient?.hdCycle }}</span>
                                      </div>
                                    }
                                    
                                    <!-- Session Info with Date -->
                                    <div class="session-info">{{ getSessionInfo(getBed(slot.slotID, bed)) }}</div>
                                    
                                    <!-- Session Duration for Active Beds -->
                                    @if (getBed(slot.slotID, bed)?.status === 'occupied' && getBed(slot.slotID, bed)?.sessionStartTime) {
                                      <div class="session-duration">
                                        <mat-icon>timer</mat-icon>
                                        <span>{{ getSessionDuration(getBed(slot.slotID, bed)) }}</span>
                                      </div>
                                    }
                                    
                                    <!-- Action Buttons -->
                                    @if (getBed(slot.slotID, bed)?.scheduleId === 0 || getBed(slot.slotID, bed)?.status === 'pre-scheduled') {
                                      <div class="action-buttons">
                                        <button class="confirm-btn"
                                                (click)="$event.stopPropagation(); confirmSuggestedSession(slot.slotID, bed)"
                                                title="Activate patient and start treatment">
                                          <mat-icon style="font-size: 14px; width: 14px; height: 14px;">play_arrow</mat-icon>
                                          Activate
                                        </button>
                                        <button class="edit-btn"
                                                (click)="$event.stopPropagation(); editSuggestedSession(slot.slotID, bed)"
                                                title="Modify schedule details">
                                          <mat-icon style="font-size: 14px; width: 14px; height: 14px;">edit_calendar</mat-icon>
                                          Modify
                                        </button>
                                      </div>
                                    } @else if (false) {
                                      <!-- Green Activate Button for Pre-Scheduled Patients -->
                                      <button class="activate-btn"
                                              (click)="$event.stopPropagation(); onBedClick(slot.slotID, bed)"
                                              title="Activate patient and start treatment">
                                        <mat-icon>play_arrow</mat-icon>
                                        <span>Activate Patient</span>
                                      </button>
                                    } @else {
                                      <div class="action-buttons horizontal">
                                        <button class="view-btn"
                                                ejs-tooltip content="View Session Details"
                                                (click)="$event.stopPropagation(); onBedClick(slot.slotID, bed)">
                                          <mat-icon>visibility</mat-icon>
                                        </button>
                                        @if (getBed(slot.slotID, bed)?.status === 'occupied') {
                                          <button class="complete-btn"
                                                  ejs-tooltip content="Mark as Completed"
                                                  (click)="$event.stopPropagation(); completeActiveSession(getBed(slot.slotID, bed))"
                                                  title="Mark treatment as completed">
                                            <mat-icon>check_circle</mat-icon>
                                            <span>Complete</span>
                                          </button>
                                        }
                                        @if (getBed(slot.slotID, bed)?.status === 'occupied' || getBed(slot.slotID, bed)?.status === 'completed') {
                                          <button class="edit-btn"
                                                  ejs-tooltip content="Edit Session"
                                                  (click)="$event.stopPropagation(); onBedClick(slot.slotID, bed)">
                                            <mat-icon>edit</mat-icon>
                                          </button>
                                        }
                                      </div>
                                    }
                                  </div>
                                } @else {
                                  <div class="empty-bed">
                                    <mat-icon>event_available</mat-icon>
                                    <span>Available</span>
                                    <button class="quick-assign-btn"
                                            (click)="$event.stopPropagation(); onQuickAssign(slot.slotID, bed)"
                                            title="Quick assign walk-in patient">
                                      <mat-icon>add</mat-icon>
                                    </button>
                                  </div>
                                }
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </div>

                    @if (schedule.slots.length === 0) {
                      <div class="empty-state">
                        <mat-icon>event_busy</mat-icon>
                        <h3>No Slots Available</h3>
                        <p>There are no dialysis slots scheduled for {{ formatDate(selectedDate) }}.</p>
                      </div>
                    }
                  </div>

                  <button class="e-btn e-fab nav-button nav-button-right" (click)="goToNextDay()" ejs-tooltip content="Next Day">
                    <mat-icon>chevron_right</mat-icon>
                  </button>
                </div>
              }
            </ng-template>
          </e-tabitem>

          <!-- Tab 2: Future Bed Schedule -->
          <e-tabitem [header]="{'text': 'Future Bed Schedule'}">
            <ng-template #content>
              @if (loading) {
                <div class="loading-container">
                  <div class="e-spinner-pane">
                    <div class="e-spinner-inner">
                      <div class="e-spin-material"></div>
                    </div>
                  </div>
                </div>
              }

              @if (!loading && futureSessions.length > 0) {
                <!-- Syncfusion Grid for Future Sessions -->
                <ejs-grid
                  [dataSource]="futureSessions"
                  [allowPaging]="true"
                  [allowSorting]="true"
                  [allowFiltering]="true"
                  [pageSettings]="{ pageSize: 10, pageSizes: [10, 20, 50, 100] }"
                  [filterSettings]="{ type: 'Excel' }"
                  [sortSettings]="{ columns: [{ field: 'sessionDate', direction: 'Ascending' }] }">
                  
                  <e-columns>
                    <e-column field="sessionDate" headerText="Session Date" width="120" textAlign="Center" type="date" format="dd MMM yyyy"></e-column>
                    <e-column field="patientName" headerText="Patient Name" width="150"></e-column>
                    <e-column field="age" headerText="Age" width="80" textAlign="Center"></e-column>
                    <e-column field="slotName" headerText="Shift" width="120"></e-column>
                    <e-column field="bedNumber" headerText="Bed" width="80" textAlign="Center"></e-column>
                    <e-column field="hdCycle" headerText="HD Cycle" width="100" textAlign="Center"></e-column>
                    <e-column 
                      field="status" 
                      headerText="Status" 
                      width="120" 
                      textAlign="Center"
                      [template]="statusTemplate">
                    </e-column>
                    <e-column 
                      headerText="Actions" 
                      width="120" 
                      textAlign="Center"
                      [template]="actionsTemplate">
                    </e-column>
                  </e-columns>
                </ejs-grid>

                <!-- Status Template -->
                <ng-template #statusTemplate let-data>
                  <ejs-chiplist>
                    <e-chips>
                      <e-chip 
                        [text]="data.status === 'pre-scheduled' ? 'Pre-Scheduled' : 'Pending'"
                        [cssClass]="data.status === 'pre-scheduled' ? 'e-success' : 'e-warning'">
                      </e-chip>
                    </e-chips>
                  </ejs-chiplist>
                </ng-template>

                <!-- Actions Template -->
                <ng-template #actionsTemplate let-data>
                  <button class="e-btn e-small e-info" (click)="navigateToWorkflow(data.patientId, data.scheduleId)">
                    <mat-icon>timeline</mat-icon>
                    Workflow
                  </button>
                </ng-template>
              }

              @if (!loading && futureSessions.length === 0) {
                <div class="empty-state">
                  <mat-icon>event_available</mat-icon>
                  <h3>No Future Sessions</h3>
                  <p>There are no pre-scheduled sessions for future dates.</p>
                </div>
              }
            </ng-template>
          </e-tabitem>
        </e-tabitems>
      </ejs-tab>
    </div>
  </div>
</div>
