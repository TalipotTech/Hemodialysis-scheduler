<div class="schedule-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <div class="header-row">
          <div class="header-left">
            <button mat-icon-button (click)="goBack()" class="back-button">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Daily HD Schedule</h2>
          </div>
          <div class="header-actions">
            <mat-form-field appearance="outline" class="date-picker">
              <mat-label>Select Date</mat-label>
              <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate" (dateChange)="onDateChange()">
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>
            <button mat-icon-button (click)="onRefresh()" matTooltip="Refresh">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Tabs for Today's Schedule and Future Bed Schedule -->
      <mat-tab-group [(selectedIndex)]="selectedTab" (selectedIndexChange)="onTabChange($event)">
        <!-- Tab 1: Today's Daily Schedule -->
        <mat-tab label="Today's Schedule">
          <!-- Statistics -->
          @if (schedule && !loading) {
            <div class="stats-row">
              <div class="stat-card">
                <div class="stat-value">{{ getTotalOccupied() }}</div>
                <div class="stat-label">Occupied Beds</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ getTotalCapacity() - getTotalOccupied() }}</div>
                <div class="stat-label">Available Beds</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ getOccupancyRate() }}%</div>
                <div class="stat-label">Occupancy Rate</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ getTotalCapacity() }}</div>
                <div class="stat-label">Total Capacity</div>
              </div>
            </div>
          }

      <!-- Loading Spinner -->
      @if (loading) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      }

      <!-- Error Message -->
      @if (errorMessage && !loading) {
        <div class="error-message">
          <mat-icon>error</mat-icon>
          {{ errorMessage }}
        </div>
      }

      <!-- Schedule Grid -->
      @if (!loading && !errorMessage && schedule) {
        <div class="schedule-grid">
          <!-- Legend with Filters -->
          <div class="legend">
            <div class="legend-item">
              <div class="legend-box bed-empty"></div>
              <mat-checkbox [(ngModel)]="showAvailable" (change)="onFilterChange()">
                Available
              </mat-checkbox>
            </div>
            <div class="legend-item">
              <div class="legend-box bed-occupied"></div>
              <mat-checkbox [(ngModel)]="showOccupied" (change)="onFilterChange()">
                Occupied
              </mat-checkbox>
            </div>
            <div class="legend-item">
              <div class="legend-box bed-reserved"></div>
              <mat-checkbox [(ngModel)]="showReserved" (change)="onFilterChange()">
                Reserved
              </mat-checkbox>
            </div>
          </div>

          <!-- Schedule Table -->
          <div class="grid-table">
            <!-- Header Row -->
            <div class="grid-row header-row">
              <div class="grid-cell slot-header">Time Slot</div>
              @for (bed of beds; track bed) {
                <div class="grid-cell bed-header">Bed {{ bed }}</div>
              }
            </div>

            <!-- Slot Rows -->
            @for (slot of schedule.slots; track slot.slotID) {
              <div class="grid-row">
                <div class="grid-cell slot-cell">
                  <div class="slot-name">{{ slot.slotName }}</div>
                  <div class="slot-time">{{ slot.timeRange }}</div>
                </div>
                @for (bed of beds; track bed) {
                  <div class="grid-cell bed-cell" 
                       [class]="getBedClass(slot.slotID, bed)"
                       [class.clickable]="getBed(slot.slotID, bed)?.status === 'occupied'"
                       [matTooltip]="getBedTooltip(slot.slotID, bed)"
                       (click)="onBedClick(slot.slotID, bed)">
                    @if (getBed(slot.slotID, bed)?.patient) {
                      <div class="bed-content">
                        <div class="patient-name">{{ getBed(slot.slotID, bed)?.patient?.name }}</div>
                        <div class="patient-age">Age: {{ getBed(slot.slotID, bed)?.patient?.age }}</div>
                        <div class="bed-actions">
                          <button mat-icon-button 
                                  class="workflow-btn"
                                  matTooltip="Start Workflow"
                                  (click)="$event.stopPropagation(); navigateToWorkflow(getBed(slot.slotID, bed)?.patient?.patientId || 0, getBed(slot.slotID, bed)?.scheduleId || 0)">
                            <mat-icon>timeline</mat-icon>
                          </button>
                          <mat-icon class="edit-icon">edit</mat-icon>
                        </div>
                      </div>
                    } @else {
                      <div class="bed-empty-text">â€”</div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }

          <!-- Empty State -->
          @if (!loading && !errorMessage && !schedule) {
            <div class="empty-state">
              <mat-icon>event_busy</mat-icon>
              <h3>No Schedule Available</h3>
              <p>No schedule found for the selected date</p>
            </div>
          }
        </mat-tab>

        <!-- Tab 2: Future Bed Schedule -->
        <mat-tab label="Bed Schedule (Future Sessions)">
          <div class="future-schedule-container">
            <div class="info-banner">
              <mat-icon>info</mat-icon>
              <span>This shows all future scheduled dialysis sessions. History tab shows only completed treatments.</span>
            </div>

            <!-- Loading Spinner -->
            @if (loadingFuture) {
              <div class="loading-container">
                <mat-spinner></mat-spinner>
              </div>
            }

            <!-- Future Sessions Table -->
            @if (!loadingFuture && futureScheduledSessions.length > 0) {
              <div class="future-schedule-table">
                <table mat-table [dataSource]="futureScheduledSessions" class="mat-elevation-z2">
                  <!-- Date Column -->
                  <ng-container matColumnDef="sessionDate">
                    <th mat-header-cell *matHeaderCellDef>Session Date</th>
                    <td mat-cell *matCellDef="let session">
                      <div class="session-date">
                        <mat-icon>event</mat-icon>
                        {{ formatDate(session.sessionDate) }}
                      </div>
                    </td>
                  </ng-container>

                  <!-- Patient Name Column -->
                  <ng-container matColumnDef="patientName">
                    <th mat-header-cell *matHeaderCellDef>Patient</th>
                    <td mat-cell *matCellDef="let session">
                      <div class="patient-info">
                        <strong>{{ session.patientName }}</strong>
                        <div class="patient-mrn">MRN: {{ session.patientMRN || 'N/A' }}</div>
                      </div>
                    </td>
                  </ng-container>

                  <!-- Age Column -->
                  <ng-container matColumnDef="age">
                    <th mat-header-cell *matHeaderCellDef>Age</th>
                    <td mat-cell *matCellDef="let session">{{ session.patientAge || 'N/A' }}</td>
                  </ng-container>

                  <!-- Slot Column -->
                  <ng-container matColumnDef="slotName">
                    <th mat-header-cell *matHeaderCellDef>Time Slot</th>
                    <td mat-cell *matCellDef="let session">
                      <div class="slot-info">
                        <mat-icon>schedule</mat-icon>
                        {{ getSlotName(session.slotID) }}
                      </div>
                    </td>
                  </ng-container>

                  <!-- Bed Number Column -->
                  <ng-container matColumnDef="bedNumber">
                    <th mat-header-cell *matHeaderCellDef>Bed</th>
                    <td mat-cell *matCellDef="let session">
                      <mat-chip [class.chip-assigned]="session.bedNumber" [class.chip-unassigned]="!session.bedNumber">
                        {{ session.bedNumber ? 'Bed ' + session.bedNumber : 'Not Assigned' }}
                      </mat-chip>
                    </td>
                  </ng-container>

                  <!-- HD Cycle Column -->
                  <ng-container matColumnDef="hdCycle">
                    <th mat-header-cell *matHeaderCellDef>HD Cycle</th>
                    <td mat-cell *matCellDef="let session">
                      <div class="hd-cycle">
                        <mat-icon>repeat</mat-icon>
                        {{ session.hdCycle || 'N/A' }}
                      </div>
                    </td>
                  </ng-container>

                  <!-- Status Column -->
                  <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let session">
                      <mat-chip [class.chip-pre-scheduled]="session.sessionStatus === 'Pre-Scheduled'" [class.chip-active]="session.sessionStatus !== 'Pre-Scheduled'">
                        {{ session.sessionStatus || 'Active' }}
                      </mat-chip>
                    </td>
                  </ng-container>

                  <!-- Actions Column -->
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let session">
                      <button mat-icon-button 
                              color="primary"
                              matTooltip="View/Edit Session Details"
                              (click)="viewSessionDetails(session.scheduleID)">
                        <mat-icon>visibility</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="futureScheduleColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: futureScheduleColumns;" 
                      class="future-session-row"></tr>
                </table>
              </div>

              <div class="summary-info">
                <mat-icon>info_outline</mat-icon>
                <span>Total Future Sessions: <strong>{{ futureScheduledSessions.length }}</strong></span>
              </div>
            }

            <!-- Empty State -->
            @if (!loadingFuture && futureScheduledSessions.length === 0) {
              <div class="empty-state">
                <mat-icon>event_available</mat-icon>
                <h3>No Future Sessions Scheduled</h3>
                <p>There are no upcoming dialysis sessions scheduled at this time.</p>
              </div>
            }
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
