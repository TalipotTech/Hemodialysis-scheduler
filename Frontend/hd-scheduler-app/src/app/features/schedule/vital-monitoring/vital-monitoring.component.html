<div class="vital-monitoring-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <div class="header-row">
          <div class="header-left">
            <button mat-icon-button (click)="goHome()" class="home-button" matTooltip="Home">
              <mat-icon>home</mat-icon>
            </button>
            <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Back">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h2>Intra-Dialytic Monitoring</h2>
          </div>
          <div class="header-actions">
            <button mat-raised-button color="primary" (click)="viewFullHistory()">
              <mat-icon>history</mat-icon>
              Patient History
            </button>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if (loading) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      }

      @if (errorMessage && !loading) {
        <div class="error-message">
          <mat-icon>error</mat-icon>
          {{ errorMessage }}
        </div>
      }

      @if (!loading && !errorMessage && sessionData) {
        <!-- Patient & Session Info -->
        <div class="session-info-banner">
          <div class="info-item">
            <mat-icon>person</mat-icon>
            <div>
              <strong>{{ sessionData.patient?.name || sessionData.sessionInfo?.patientName || 'N/A' }}</strong>
              <span class="subtitle">MRN: {{ sessionData.patient?.mrn || sessionData.sessionInfo?.patientMRN || 'N/A' }}</span>
              <span class="subtitle">Age: {{ sessionData.patient?.age || sessionData.sessionInfo?.patientAge || 'N/A' }} years</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>event</mat-icon>
            <div>
              <strong>{{ sessionData.sessionInfo?.sessionDate | date:'fullDate' }}</strong>
              <span class="subtitle">{{ sessionData.sessionInfo?.slotName || 'Slot ' + sessionData.sessionInfo?.slotID }}</span>
              <span class="subtitle">Session ID: #{{ scheduleId }}</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>bed</mat-icon>
            <div>
              <strong>Bed {{ sessionData.sessionInfo?.bedNumber }}</strong>
              <span class="subtitle">{{ sessionData.sessionInfo?.dialyserType }}</span>
              <span class="subtitle">Duration: {{ sessionData.sessionInfo?.prescribedDuration }}hrs</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>medical_services</mat-icon>
            <div>
              <strong>Treatment Details</strong>
              <span class="subtitle">Dry Weight: {{ sessionData.sessionInfo?.dryWeight }}kg</span>
              <span class="subtitle">UF Goal: {{ sessionData.sessionInfo?.ufGoal }}L</span>
            </div>
          </div>
        </div>

        <!-- Auto-save Status Indicator -->
        <div class="auto-save-status" [ngClass]="saveStatus">
          @if (saveStatus === 'saving') {
            <mat-icon>cloud_upload</mat-icon>
            <span>Auto-saving draft...</span>
          }
          @if (saveStatus === 'saved') {
            <mat-icon>cloud_done</mat-icon>
            <span>Draft saved at {{ lastSavedTime | date:'shortTime' }}</span>
          }
          @if (saveStatus === 'idle' && !lastSavedTime) {
            <mat-icon>info</mat-icon>
            <span>✓ Data auto-saves as you type - Your entries are safe!</span>
          }
        </div>

        <!-- Vital Signs Recording Form -->
        <div class="vital-form-section">
          <h3><mat-icon>monitor_heart</mat-icon> Record Vital Signs</h3>
          
          <form [formGroup]="vitalForm" (ngSubmit)="recordVitals()">
            <div class="form-grid">
              <!-- Blood Pressure -->
              <mat-form-field appearance="outline">
                <mat-label>Blood Pressure</mat-label>
                <input matInput formControlName="bloodPressure" placeholder="120/80">
                <mat-icon matPrefix>favorite</mat-icon>
                <mat-hint>Format: Systolic/Diastolic</mat-hint>
                @if (vitalForm.get('bloodPressure')?.hasError('required') && vitalForm.get('bloodPressure')?.touched) {
                  <mat-error>Blood pressure is required</mat-error>
                }
              </mat-form-field>

              <!-- Pulse Rate -->
              <mat-form-field appearance="outline">
                <mat-label>Pulse Rate (bpm)</mat-label>
                <input matInput type="number" formControlName="pulseRate" placeholder="75">
                <mat-icon matPrefix>monitor_heart</mat-icon>
                @if (vitalForm.get('pulseRate')?.hasError('required') && vitalForm.get('pulseRate')?.touched) {
                  <mat-error>Pulse rate is required</mat-error>
                }
                @if (vitalForm.get('pulseRate')?.hasError('min') || vitalForm.get('pulseRate')?.hasError('max')) {
                  <mat-error>Must be between 40-200 bpm</mat-error>
                }
              </mat-form-field>

              <!-- Temperature -->
              <mat-form-field appearance="outline">
                <mat-label>Temperature (°C)</mat-label>
                <input matInput type="number" step="0.1" formControlName="temperature" placeholder="36.5">
                <mat-icon matPrefix>thermostat</mat-icon>
                @if (vitalForm.get('temperature')?.hasError('required') && vitalForm.get('temperature')?.touched) {
                  <mat-error>Temperature is required</mat-error>
                }
                @if (vitalForm.get('temperature')?.hasError('min') || vitalForm.get('temperature')?.hasError('max')) {
                  <mat-error>Must be between 35-42°C</mat-error>
                }
              </mat-form-field>

              <!-- UF Volume -->
              <mat-form-field appearance="outline">
                <mat-label>UF Volume (L)</mat-label>
                <input matInput type="number" step="0.1" formControlName="ufVolume" placeholder="2.5">
                <mat-icon matPrefix>water_drop</mat-icon>
                @if (vitalForm.get('ufVolume')?.hasError('required') && vitalForm.get('ufVolume')?.touched) {
                  <mat-error>UF volume is required</mat-error>
                }
                @if (vitalForm.get('ufVolume')?.hasError('min')) {
                  <mat-error>Must be 0 or greater</mat-error>
                }
              </mat-form-field>

              <!-- Actual Blood Flow Rate -->
              <mat-form-field appearance="outline">
                <mat-label>Blood Flow Rate (mL/min)</mat-label>
                <input matInput type="number" formControlName="actualBFR" placeholder="300">
                <mat-icon matPrefix>bloodtype</mat-icon>
                <mat-hint>Optional</mat-hint>
                @if (vitalForm.get('actualBFR')?.hasError('min') || vitalForm.get('actualBFR')?.hasError('max')) {
                  <mat-error>Must be between 50-600 mL/min</mat-error>
                }
              </mat-form-field>

              <!-- Venous Pressure -->
              <mat-form-field appearance="outline">
                <mat-label>Venous Pressure (mmHg)</mat-label>
                <input matInput type="number" formControlName="venousPressure" placeholder="150">
                <mat-icon matPrefix>speed</mat-icon>
                <mat-hint>Optional</mat-hint>
              </mat-form-field>

              <!-- Arterial Pressure -->
              <mat-form-field appearance="outline">
                <mat-label>Arterial Pressure (mmHg)</mat-label>
                <input matInput type="number" formControlName="arterialPressure" placeholder="-200">
                <mat-icon matPrefix>speed</mat-icon>
                <mat-hint>Optional</mat-hint>
              </mat-form-field>

              <!-- TMP Pressure -->
              <mat-form-field appearance="outline">
                <mat-label>TMP Pressure (mmHg)</mat-label>
                <input matInput type="number" formControlName="tmpPressure" placeholder="120">
                <mat-icon matPrefix>compress</mat-icon>
                <mat-hint>Optional</mat-hint>
              </mat-form-field>

              <!-- Symptoms -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Symptoms</mat-label>
                <textarea matInput formControlName="symptoms" rows="2" placeholder="Any symptoms or complaints..."></textarea>
                <mat-icon matPrefix>healing</mat-icon>
                <mat-hint>Optional</mat-hint>
              </mat-form-field>

              <!-- Interventions -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Interventions</mat-label>
                <textarea matInput formControlName="interventions" rows="2" placeholder="Any interventions taken..."></textarea>
                <mat-icon matPrefix>medical_services</mat-icon>
                <mat-hint>Optional</mat-hint>
              </mat-form-field>
            </div>

            <div class="form-actions">
              <button mat-raised-button color="primary" type="submit" [disabled]="saving || vitalForm.invalid">
                <mat-icon>save</mat-icon>
                {{ saving ? 'Recording...' : 'Record Vitals to Patient History' }}
              </button>
              <button mat-button type="button" (click)="vitalForm.reset()" [disabled]="saving">
                <mat-icon>clear</mat-icon>
                Clear Form
              </button>
            </div>
          </form>
        </div>

        <!-- Monitoring Records Table -->
        <div class="monitoring-records-section">
          <h3>
            <mat-icon>timeline</mat-icon> 
            Monitoring History (All Vitals Saved to Patient Record)
          </h3>
          
          @if (monitoringRecords.length === 0) {
            <div class="no-records">
              <mat-icon>info</mat-icon>
              <p>No monitoring records yet for this session.</p>
              <p><strong>Record vital signs above to permanently save them to this patient's medical history.</strong></p>
            </div>
          } @else {
            <div class="records-info">
              <mat-chip highlighted>
                <mat-icon>check_circle</mat-icon>
                {{ monitoringRecords.length }} vital sign(s) recorded and saved
              </mat-chip>
            </div>
            <div class="table-container">
              <table mat-table [dataSource]="monitoringRecords" class="monitoring-table">
                <ng-container matColumnDef="time">
                  <th mat-header-cell *matHeaderCellDef>Time</th>
                  <td mat-cell *matCellDef="let record">
                    {{ record.timeRecorded | date:'shortTime' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="bp">
                  <th mat-header-cell *matHeaderCellDef>Blood Pressure</th>
                  <td mat-cell *matCellDef="let record">{{ record.bloodPressure || 'N/A' }}</td>
                </ng-container>

                <ng-container matColumnDef="pulse">
                  <th mat-header-cell *matHeaderCellDef>Pulse Rate</th>
                  <td mat-cell *matCellDef="let record">{{ record.pulseRate || 'N/A' }} bpm</td>
                </ng-container>

                <ng-container matColumnDef="temp">
                  <th mat-header-cell *matHeaderCellDef>Temperature</th>
                  <td mat-cell *matCellDef="let record">{{ record.temperature || 'N/A' }}°C</td>
                </ng-container>

                <ng-container matColumnDef="uf">
                  <th mat-header-cell *matHeaderCellDef>UF Volume</th>
                  <td mat-cell *matCellDef="let record">{{ record.ufVolume || 'N/A' }} L</td>
                </ng-container>

                <ng-container matColumnDef="bfr">
                  <th mat-header-cell *matHeaderCellDef>BFR</th>
                  <td mat-cell *matCellDef="let record">{{ record.actualBFR || 'N/A' }}</td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let record">
                    <button mat-icon-button color="warn" (click)="deleteRecord(record.monitoringID)" matTooltip="Delete">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
              </table>
            </div>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>
