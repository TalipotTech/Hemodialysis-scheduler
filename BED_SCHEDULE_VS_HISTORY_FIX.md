# Bed Schedule vs History - Implementation Guide

## Problem Solved

When entering patient information with HD cycle (e.g., Tuesday/Thursday/Saturday), the system was creating future sessions and showing them in **History** immediately, which was confusing. Staff need to see future scheduled sessions in the **Bed Schedule** view, and only completed treatments should appear in **History**.

## Solution Implemented

### Backend Changes ✅

#### 1. **New API Endpoint** - `/api/hdschedule/future-scheduled`
This endpoint returns all future scheduled dialysis sessions (today and beyond) that haven't been completed yet.

**Query Logic:**
```sql
WHERE h.IsMovedToHistory = 0 
  AND h.IsDischarged = 0
  AND date(h.SessionDate) >= date('now')
ORDER BY h.SessionDate ASC, h.SlotID ASC, h.BedNumber ASC
```

**Returns:**
- All pre-scheduled sessions (created from HD cycle)
- Active sessions for today and future
- Includes basic patient info: Name, Age, MRN
- Shows Slot ID, Bed Number, Session Date

#### 2. **History Endpoint Unchanged** - `/api/hdschedule/history`
This continues to return only completed treatment sessions.

**Query Logic:**
```sql
WHERE h.IsMovedToHistory = 1
ORDER BY h.SessionDate DESC, h.UpdatedAt DESC
```

**Returns:**
- Only sessions that were actually performed
- Sessions that have been moved to history after treatment completion
- Does NOT include future scheduled sessions

### Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│ PATIENT REGISTRATION WITH HD CYCLE                               │
│ Example: Tuesday/Thursday/Saturday (3x/week)                    │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
         ┌─────────────────────────────┐
         │ CREATE BASE SESSION         │
         │ - SessionDate: Nov 24, 2025 │
         │ - SessionStatus: "Active"   │
         │ - Bed assigned              │
         └─────────────┬───────────────┘
                       │
                       ▼
         ┌─────────────────────────────────────┐
         │ AUTO-CREATE RECURRING SESSIONS      │
         │ - Nov 26 (Tuesday)                  │
         │ - Nov 28 (Thursday)                 │
         │ - Nov 29 (Saturday)                 │
         │ SessionStatus: "Pre-Scheduled"      │
         │ IsAutoGenerated: true               │
         │ BedNumber: NULL (assign later)      │
         └─────────────┬───────────────────────┘
                       │
         ┌─────────────┴─────────────┐
         │                           │
         ▼                           ▼
┌──────────────────┐        ┌──────────────────┐
│  BED SCHEDULE    │        │    HISTORY       │
│  (Future View)   │        │ (Past Treatments)│
├──────────────────┤        ├──────────────────┤
│ ✓ Nov 24 - Bed 1 │        │ (EMPTY until     │
│ ✓ Nov 26 - TBD   │        │  treatment done) │
│ ✓ Nov 28 - TBD   │        │                  │
│ ✓ Nov 29 - TBD   │        │                  │
└──────────────────┘        └──────────────────┘
         │                           ▲
         │ Treatment Day Arrives     │
         ▼                           │
┌──────────────────┐                │
│ PATIENT TREATED  │                │
│ - Vitals taken   │                │
│ - Treatment done │                │
│ - Discharged     │                │
└─────────┬────────┘                │
          │                         │
          │ System Auto-Move        │
          └─────────────────────────┘
                 (5 hours after slot start)
```

### Frontend Changes ✅

#### Schedule Service Updated
Added new method:
```typescript
getFutureScheduledSessions(): Observable<ApiResponse<any[]>> {
  return this.http.get<ApiResponse<any[]>>(
    `${environment.apiUrl}/hdschedule/future-scheduled`
  );
}
```

## How to Use

### For Bed Schedule View

**API Call:**
```typescript
this.scheduleService.getFutureScheduledSessions().subscribe({
  next: (response) => {
    if (response.success) {
      // response.data contains all future scheduled sessions
      // Grouped by date, slot, and bed
      this.futureSchedule = response.data;
    }
  }
});
```

**Example Response:**
```json
{
  "success": true,
  "message": "Retrieved 12 future scheduled sessions",
  "data": [
    {
      "scheduleID": 101,
      "patientID": 5,
      "patientName": "John Doe",
      "patientAge": 45,
      "patientMRN": "MRN001",
      "sessionDate": "2025-11-26T00:00:00",
      "slotID": 1,
      "bedNumber": null,
      "sessionStatus": "Pre-Scheduled",
      "hdCycle": "TTS",
      "dryWeight": 65.5,
      "prescribedDuration": 4.0
    },
    ...
  ]
}
```

### For History View

**API Call (unchanged):**
```typescript
this.scheduleService.getHistorySessions().subscribe({
  next: (response) => {
    if (response.success) {
      // response.data contains only completed treatments
      this.historyRecords = response.data;
    }
  }
});
```

## Expected Behavior

### ✅ CORRECT: Bed Schedule
Shows:
- Today's active sessions (being treated right now)
- Future pre-scheduled sessions (Tuesday, Thursday, Saturday)
- Patient basic info visible for staff planning
- Beds can be assigned before treatment day
- Sessions show with status: "Pre-Scheduled" or "Active"

### ✅ CORRECT: History
Shows ONLY:
- Sessions that were actually performed
- Completed treatments (after patient was discharged)
- Sessions automatically moved after 5 hours from slot start time
- Status: "Completed" or "Discharged"

### ❌ INCORRECT (OLD BEHAVIOR):
- Future sessions appearing in History ❌
- Empty History when sessions are pre-scheduled ❌
- Confusion about which sessions are planned vs completed ❌

## Testing Checklist

1. **Create Patient with HD Cycle:**
   - Enter patient info
   - Set HD Cycle: "Tuesday, Thursday, Saturday"
   - Complete registration
   
2. **Check Bed Schedule:**
   - Navigate to Bed Schedule
   - ✅ Should see today's session (if applicable)
   - ✅ Should see next 3 upcoming sessions (Tue, Thu, Sat)
   - ✅ Basic patient info visible for each
   
3. **Check History:**
   - Navigate to History
   - ❌ Should NOT see future sessions
   - ✅ Should be empty (no treatments performed yet)
   
4. **Perform Treatment:**
   - Complete a dialysis session
   - Wait 5 hours OR manually move to history
   
5. **Verify Movement:**
   - ✅ Session disappears from Bed Schedule
   - ✅ Session appears in History
   - ✅ Future sessions remain in Bed Schedule

## Database Schema

### HDSchedule Table Key Fields

| Field | Purpose | Bed Schedule | History |
|-------|---------|--------------|---------|
| `SessionDate` | Treatment date | Today + Future | Past dates |
| `SessionStatus` | Current state | "Active", "Pre-Scheduled" | "Completed" |
| `IsMovedToHistory` | Completion flag | 0 (False) | 1 (True) |
| `IsDischarged` | Discharge flag | 0 (False) | 1 (True) |
| `IsAutoGenerated` | Recurring session | TRUE for future | N/A |
| `ParentScheduleID` | Link to original | Points to base session | N/A |

## API Endpoints Summary

| Endpoint | Purpose | Use Case |
|----------|---------|----------|
| `GET /api/hdschedule/future-scheduled` | Future sessions for bed planning | Bed Schedule view, staff planning |
| `GET /api/hdschedule/history` | Completed treatments only | Patient treatment history, reports |
| `GET /api/hdschedule/today` | Today's active sessions | Real-time monitoring, current operations |
| `GET /api/hdschedule/active` | All non-discharged sessions | Overall capacity management |

## Implementation Status

- ✅ Backend API endpoint created
- ✅ Repository method implemented
- ✅ Controller action added
- ✅ Frontend service method added
- ⏳ **Frontend UI needs update** (see next section)

## Next Steps - Frontend UI Update

To complete the implementation, update the schedule view component to use the new endpoint:

### Option 1: Add Tabs to Schedule View

```typescript
// In schedule-grid.ts or similar
viewMode: 'bed-schedule' | 'history' = 'bed-schedule';

loadData() {
  if (this.viewMode === 'bed-schedule') {
    this.scheduleService.getFutureScheduledSessions().subscribe(...);
  } else {
    this.scheduleService.getHistorySessions().subscribe(...);
  }
}
```

### Option 2: Separate Views

Create two distinct navigation items:
- "Bed Schedule" → Shows future planned sessions
- "Treatment History" → Shows completed sessions

## Benefits

1. ✅ **Clear Separation** - Staff know where to look for what
2. ✅ **Better Planning** - Future sessions visible for bed assignments
3. ✅ **Accurate History** - Only actual treatments recorded
4. ✅ **Reduced Confusion** - No mixing of planned vs completed sessions
5. ✅ **Workflow Clarity** - Matches clinical workflow expectations

## Technical Notes

- Sessions are automatically moved to history 5 hours after their slot start time
- Pre-scheduled sessions can have bed assigned manually by staff before treatment day
- The `SessionStatus` field tracks: "Pre-Scheduled" → "Active" → "Completed"
- Equipment usage counts only increment on actual treatment, not on scheduling

---

**Status:** Backend implementation complete ✅  
**Next:** Update frontend UI to use new endpoint  
**Date:** November 24, 2025
